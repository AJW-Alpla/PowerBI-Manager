<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPLA - Power BI Rights Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e5e5e5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid #999999;
            overflow: visible;
        }
        
        .header {
            background: white;
            color: #004d90;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 3px solid #004d90;
        }

        .header-logo {
            height: 50px;
            width: auto;
        }

        .header-content {
            flex: 1;
        }

        .header h1 { font-size: 28px; margin-bottom: 10px; color: #004d90; }
        .header p { opacity: 0.8; font-size: 14px; color: #333333; }
        
        .auth-section {
            padding: 30px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-badge.authenticated { background: #d4edda; color: #155724; }
        .status-badge.not-authenticated { background: #f8d7da; color: #721c24; }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            background: #004d90;
            color: white;
            transition: all 0.3s;
        }
        
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .button-secondary { background: #6c757d; }
        .button-success { background: #28a745; }
        .button-danger { background: #dc3545; }

        .admin-badge {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 10px;
        }

        .admin-warning-border {
            border-left: 4px solid #ffc107 !important;
        }

        .view-toggle {
            padding: 10px 20px;
            border: 2px solid #999999;
            background: white;
            color: #333333;
        }

        .view-toggle.active {
            background: #004d90;
            color: white;
            border-color: transparent;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cccccc;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #999999;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #e0e0e0; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background: #f8f9fa; }
        
        .checkbox-cell { width: 40px; text-align: center; }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #004d90;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #004d90;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 600;
        }
        
        .role-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .role-badge.role-admin { background: #e3f2fd; color: #1976d2; }
        .role-badge.role-member { background: #f3e5f5; color: #7b1fa2; }
        .role-badge.role-contributor { background: #fff3e0; color: #e65100; }
        .role-badge.role-viewer { background: #e8f5e9; color: #2e7d32; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 3px solid #999999;
        }
        
        .modal-header {
            background: #004d90;
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; }
        
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10001;
            max-width: 400px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .alert.info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        
        .user-search-dropdown {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #999999;
            border-radius: 6px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }
        
        .user-search-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-search-item:hover { background: #f8f9fa; }
        
        .user-search-section {
            padding: 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .pending-changes {
            background: #fff3e6;
            border: 2px solid #ff6b00;
            padding: 15px 30px;
            margin: 0 30px 20px;
            border-radius: 6px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #004d90;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160.43 30" class="header-logo">
                <path d="M133.91,17.52l4.46-7.65h0l4.46,7.65ZM84.58,12.75H80V7.86h4.54c2.51,0,4.54,1.1,4.54,2.45s-2,2.45-4.54,2.45m-67,4.77,4.46-7.65h0l4.46,7.65Zm142.46,8.16h0L144,2.1h0C143.09.84,140.86,0,138.37,0s-4.72.84-5.59,2.1h0L119.31,21.82h-8.12V3.21c0-1.77-2.66-3.21-6-3.21s-6,1.44-6,3.21v2.4C96.55,2.28,91,0,84.58,0H74.09c-3.29,0-6,1.44-6,3.21V23.8a7.39,7.39,0,0,0-5.36-2h-8.2V3.21c0-1.77-2.67-3.21-6-3.21s-6,1.44-6,3.21V24.1l-15-22h0C26.78.84,24.55,0,22.06,0s-4.73.84-5.59,2.1h0L.37,25.68h0A2,2,0,0,0,0,26.79C0,28.56,2.67,30,6,30c2.6,0,4.9-.91,5.68-2.25l1.82-3.11H30.67l1.82,3.11c.78,1.34,3.08,2.25,5.68,2.25a7.71,7.71,0,0,0,5.23-1.68A7.7,7.7,0,0,0,48.63,30H62.78a7.09,7.09,0,0,0,5.61-2.28c.74,1.32,3,2.28,5.7,2.28,3.29,0,6-1.44,6-3.21V20.61h4.54c6.41,0,12-2.28,14.71-5.61V26.79c0,1.77,2.67,3.21,6,3.21h17c2.6,0,4.9-.91,5.68-2.25l1.82-3.11H147l1.82,3.11c.78,1.34,3.08,2.25,5.68,2.25,3.29,0,6-1.44,6-3.21a2,2,0,0,0-.37-1.11" fill="#004d90"/>
            </svg>
            <div class="header-content">
                <h1>Power BI Rights Manager</h1>
                <p>Manage workspace permissions and user access</p>
            </div>
        </div>
        
        <div class="auth-section">
            <span id="authStatus" class="status-badge not-authenticated">‚ö†Ô∏è Not Authenticated</span>
            <button onclick="showManualTokenModal()" style="background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);">
                <span style="display: inline-flex; align-items: center; gap: 8px;">
                    <svg width="16" height="16" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
                    Sign in with Power BI
                </span>
            </button>
            <button onclick="signOut()" id="signOutBtn" class="button-secondary" style="display: none;">Sign out</button>

            <div style="display: flex; gap: 10px; margin-left: auto;">
                <button id="workspaceViewBtn" onclick="switchView('workspace')" class="view-toggle active">
                    üìÅ Workspace View
                </button>
                <button id="userViewBtn" onclick="switchView('user')" class="view-toggle">
                    üë§ User View
                </button>
                <button id="adminViewBtn" onclick="switchView('admin')" class="view-toggle" style="display: none;">
                    üîß Admin Panel
                </button>
            </div>
        </div>
        
        <!-- WORKSPACE VIEW -->
        <div id="workspaceView">
            <div style="padding: 30px; border-bottom: 1px solid #e0e0e0;">
                <h2>üìÅ Workspace User Manager</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Enter a workspace name to see and manage all users
                </p>
                <div style="max-width: 600px;">
                    <div style="display: flex; gap: 10px; position: relative;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" id="workspaceSearch"
                                   placeholder="üìÅ Enter workspace name (e.g., Sales Reports)"
                                   style="width: 100%;" disabled
                                   oninput="showWorkspaceSuggestions()"
                                   onkeypress="if(event.key === 'Enter') { hideWorkspaceSuggestions(); searchWorkspace(); }"
                                   onfocus="showWorkspaceSuggestions()"
                                   autocomplete="off">
                            <div id="workspaceSuggestions" class="user-search-dropdown" style="display: none;"></div>
                        </div>
                        <button onclick="searchWorkspace()" class="button-success" id="searchWorkspaceBtn" disabled>Search</button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        üí° Start typing to see matching workspaces
                    </p>
                </div>
                <div id="selectedWorkspaceInfo" style="display: none; margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Selected Workspace:</strong> <span id="selectedWorkspaceName"></span>
                        </div>
                        <button onclick="clearWorkspaceSelection()" class="button-secondary">Change Workspace</button>
                    </div>
                </div>
            </div>
            
            <div id="pendingChangesContainer" class="pending-changes" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #ff6b00; margin-bottom: 10px;">
                            ‚ö†Ô∏è <span id="pendingChangesCount">0</span> Pending Changes
                        </div>
                        <div id="pendingChangesList" style="max-height: 150px; overflow-y: auto; font-size: 13px;"></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="applyPendingRoleChanges()" class="button-success">‚úì Apply</button>
                        <button onclick="cancelPendingRoleChanges()" class="button-secondary">‚úó Cancel</button>
                    </div>
                </div>
            </div>
            
            <div style="padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="workspaceInfo">Users & Permissions</h3>
                    <button onclick="showAddUserModal()" class="button-success" id="addUserBtn" style="display: none;">
                        ‚ûï Add User
                    </button>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div id="workspaceBulkActions" style="display: none; gap: 10px; padding: 15px; background: #fff3e6;
                     border: 2px solid #ff6b00; border-radius: 6px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <span id="selectedUsersCount" style="font-weight: 600; color: #ff6b00;">0 selected</span>
                    <button onclick="bulkSetRole('Admin')">Set Admin</button>
                    <button onclick="bulkSetRole('Member')">Set Member</button>
                    <button onclick="bulkSetRole('Contributor')">Set Contributor</button>
                    <button onclick="bulkSetRole('Viewer')">Set Viewer</button>
                    <button onclick="bulkRemoveUsers()" class="button-danger">Remove from Selected</button>
                </div>

                <!-- Group Permissions Warning -->
                <div id="groupPermissionsWarning" style="display: none; padding: 12px 15px; background: #e7f3ff;
                     border-left: 4px solid #0078d4; border-radius: 4px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 20px;">‚ÑπÔ∏è</span>
                        <div style="flex: 1;">
                            <strong style="color: #0078d4;">Group-Based Permissions Detected</strong>
                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #555;">
                                This workspace has groups with Admin/Member permissions. You don't have direct user access,
                                but if you're a member of these groups, you may have permissions. Actions are enabled to allow
                                group-based access - the PowerBI API will validate your actual permissions when you perform actions.
                            </p>
                        </div>
                    </div>
                </div>

                <table id="usersTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" onchange="toggleSelectAll(this.checked)"></th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Current Role</th>
                            <th>Assign Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="6" class="empty-state">
                            <div style="padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                                <p>Enter a workspace name above to view and manage users</p>
                            </div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- USER VIEW -->
        <div id="userView" style="display: none;">
            <div style="padding: 30px; border-bottom: 1px solid #e0e0e0;">
                <h2>üë§ User & Group Workspace Manager</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Enter a user's email or group name to see and manage all their workspace access
                </p>
                <div style="max-width: 900px;">
                    <div style="display: flex; gap: 10px; position: relative;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" id="userViewEmailInput"
                                   placeholder="üìß Enter user email or group name (e.g., john.doe@company.com or BI-Global-Admin)"
                                   style="width: 100%;"
                                   oninput="showUserSuggestions()"
                                   onkeypress="if(event.key === 'Enter') { hideUserSuggestions(); searchUserByEmail(); }"
                                   onfocus="showUserSuggestions()"
                                   autocomplete="off">
                            <div id="userSuggestions" class="user-search-dropdown" style="display: none; min-width: 500px;"></div>
                        </div>
                        <button onclick="searchUserByEmail()" class="button-success">Search</button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        üí° Start typing to see users and groups from loaded workspaces
                    </p>
                </div>
                <div id="selectedUserPanel" style="display: none; margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>Selected User:</strong> <span id="selectedUserPanelName"></span>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                <span id="selectedUserPanelEmail"></span> ‚Ä¢ <strong id="workspaceCount">0</strong> workspaces
                            </div>
                        </div>
                        <button onclick="clearUserSelection()" class="button-secondary">Change User</button>
                    </div>
                </div>
            </div>
            
            <div id="userWorkspacesContainer" style="display: none; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Workspace Access</h3>
                    <button onclick="showAddWorkspaceAccessModal()" class="button-success" id="addWorkspaceAccessBtn">
                        ‚ûï Add Workspace Access
                    </button>
                </div>
                
                <!-- Bulk Actions Bar (Top Position) -->
                <div id="userBulkActions" style="display: none; gap: 10px; padding: 15px; background: #fff3e6; 
                     border: 2px solid #ff6b00; border-radius: 6px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <span id="selectedWorkspacesCount" style="font-weight: 600; color: #ff6b00;">0 selected</span>
                    <button onclick="bulkChangeUserRole('Admin')">Set Admin</button>
                    <button onclick="bulkChangeUserRole('Member')">Set Member</button>
                    <button onclick="bulkChangeUserRole('Contributor')">Set Contributor</button>
                    <button onclick="bulkChangeUserRole('Viewer')">Set Viewer</button>
                    <button onclick="bulkRemoveUserFromWorkspaces()" class="button-danger">Remove from Selected</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" onchange="toggleAllUserWorkspaces(this.checked)"></th>
                            <th>Workspace Name</th>
                            <th>Current Role</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userWorkspacesTable">
                        <tr><td colspan="5" class="empty-state">
                            <div style="padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üë§</div>
                                <p>Enter a user email above to view their workspace access</p>
                            </div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADMIN VIEW (Power BI Administrators Only) -->
    <div id="adminView" style="display: none;">
        <div style="padding: 30px; background: #fff3cd; border-bottom: 3px solid #ffc107;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 32px;">‚ö†Ô∏è</span>
                <div>
                    <h2 style="color: #856404; margin-bottom: 5px;">üîß Power BI Administrator Panel</h2>
                    <p style="color: #856404; margin: 0;">
                        You have elevated privileges. Changes affect the entire organization.
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Mode Selector -->
        <div style="padding: 30px; border-bottom: 1px solid #e0e0e0;">
            <div style="display: flex; gap: 10px;">
                <button id="adminModeWorkspaceBtn" onclick="switchAdminMode('workspace')" class="view-toggle active">
                    üìÅ Assign Users to Workspace
                </button>
                <button id="adminModeUserBtn" onclick="switchAdminMode('user')" class="view-toggle">
                    üë§ Assign Workspaces to User
                </button>
            </div>
        </div>

        <!-- Help Section -->
        <div style="padding: 15px 20px; background: #e7f3ff; margin: 20px 20px 0 20px; border-radius: 6px; border-left: 4px solid #004d90;">
            <details style="cursor: pointer;">
                <summary style="font-weight: 600; color: #004d90; margin-bottom: 5px;">‚ÑπÔ∏è About Admin Panel (click to expand)</summary>
                <ul style="margin: 10px 0 0 20px; line-height: 1.6; color: #333; font-size: 13px;">
                    <li><strong>Workspace Mode:</strong> Select a workspace and add multiple users/groups to it</li>
                    <li><strong>User Mode:</strong> Select a user/group and add them to multiple workspaces</li>
                    <li><strong>Scope:</strong> You can manage ANY workspace in the organization</li>
                </ul>
            </details>
        </div>

        <!-- Admin Mode: Assign Users to Workspace -->
        <div id="adminAssignToWorkspace" style="background: white;">
            <div style="padding: 30px; border-bottom: 2px solid #e0e0e0; background: #f8f9fa;">
                <h3 style="color: #004d90; margin-bottom: 10px;">üìÅ Step 1: Select Workspace</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                    Search from all organizational workspaces (admin access)
                </p>
                <div style="position: relative;">
                    <input type="text" id="adminWorkspaceSearch"
                           placeholder="üîç Type workspace name to search..."
                           oninput="showAdminWorkspaceSuggestions()"
                           onfocus="showAdminWorkspaceSuggestions()"
                           autocomplete="off"
                           style="width: 100%; max-width: 600px; padding: 14px 20px; border: 2px solid #004d90; border-radius: 8px; font-size: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div id="adminWorkspaceSuggestions" class="user-search-dropdown" style="display: none;"></div>
                </div>
                <div id="adminSelectedWorkspaceInfo" style="display: none; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px; border: 2px solid #28a745;">
                    <strong style="color: #155724;">‚úì Selected Workspace:</strong> <span id="adminSelectedWorkspaceName" style="color: #155724; font-weight: 600;"></span>
                </div>
            </div>

            <div style="padding: 30px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #004d90;">üë• Step 2: Add Users/Groups</h3>
                    <button onclick="showAdminBulkAddModal()" class="button-success" id="adminBulkAddBtn" style="display: none;">
                        ‚ûï Add Multiple Users/Groups
                    </button>
                </div>
                <div id="adminAssignUsersPlaceholder" class="empty-state" style="background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px;">
                    <div style="padding: 50px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 15px; opacity: 0.3;">üë•</div>
                        <p style="color: #666; font-size: 15px;">Select a workspace above to assign users/groups</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Mode: Assign Workspaces to User -->
        <div id="adminAssignToUser" style="display: none; background: white;">
            <div style="padding: 30px; border-bottom: 2px solid #e0e0e0; background: #f8f9fa;">
                <h3 style="color: #004d90; margin-bottom: 10px;">üë§ Step 1: Select User or Group</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                    Enter user email or group name
                </p>
                <div style="position: relative;">
                    <input type="text" id="adminUserSearch"
                           placeholder="üîç Type user email or group name to search..."
                           oninput="showAdminUserSuggestions()"
                           onfocus="showAdminUserSuggestions()"
                           autocomplete="off"
                           style="width: 100%; max-width: 600px; padding: 14px 20px; border: 2px solid #004d90; border-radius: 8px; font-size: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div id="adminUserSuggestions" class="user-search-dropdown" style="display: none;"></div>
                </div>
                <div id="adminSelectedUserInfo" style="display: none; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px; border: 2px solid #28a745;">
                    <strong style="color: #155724;">‚úì Selected:</strong> <span id="adminSelectedUserName" style="color: #155724; font-weight: 600;"></span>
                </div>
            </div>

            <div style="padding: 30px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #004d90;">üìÅ Step 2: Add to Workspaces</h3>
                    <button onclick="showAdminBulkWorkspaceModal()" class="button-success" id="adminBulkWorkspaceBtn" style="display: none;">
                        ‚ûï Add to Multiple Workspaces
                    </button>
                </div>
                <div id="adminAssignWorkspacesPlaceholder" class="empty-state" style="background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px;">
                    <div style="padding: 50px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 15px; opacity: 0.3;">üìÅ</div>
                        <p style="color: #666; font-size: 15px;">Select a user/group above to assign workspaces</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Sign in to Power BI</h2>
            </div>
            <div class="modal-body">
                <div style="padding: 15px; background: #e3f2fd; border-radius: 6px; margin-bottom: 20px; border: 1px solid #2196f3;">
                    <p style="color: #1565c0; font-size: 13px;">
                        <strong>Step 1:</strong> Run this command in PowerShell (opens Microsoft login):
                    </p>
                </div>
                <div style="background: #1e1e1e; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <code id="psCommand" style="display: block; color: #9cdcfe; font-family: 'Cascadia Code', Consolas, monospace; font-size: 12px; white-space: pre-wrap; line-height: 1.6; cursor: pointer;"
                          onclick="copyPowerShellCommand()" title="Click to copy">if (-not (Get-Module -ListAvailable -Name MicrosoftPowerBIMgmt)) { Write-Host "PowerBI module not found. Installing..." -ForegroundColor Yellow; Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force }; Connect-PowerBIServiceAccount; (Get-PowerBIAccessToken).Authorization.Replace("Bearer ","") | Set-Clipboard; Write-Host "Token copied!" -ForegroundColor Green</code>
                    <button onclick="copyPowerShellCommand()" style="margin-top: 10px; font-size: 11px; padding: 5px 10px;">üìã Copy Command</button>
                </div>
                <div style="padding: 15px; background: #e8f5e9; border-radius: 6px; margin-bottom: 20px; border: 1px solid #4caf50;">
                    <p style="color: #2e7d32; font-size: 13px;">
                        <strong>Step 2:</strong> After signing in, the token is copied. Paste it below:
                    </p>
                </div>
                <div class="form-group">
                    <label>Access Token:</label>
                    <textarea id="manualToken" placeholder="Paste token here (Ctrl+V)..."
                              style="min-height: 100px; font-family: monospace; font-size: 11px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAuthModal()" class="button-secondary">Cancel</button>
                <button onclick="authenticateWithToken()" class="button-success">‚úÖ Sign In</button>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header"><h2>‚ûï Add User/Group</h2></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search User or Group</label>
                    <div style="position: relative;">
                        <input type="text" id="newUserEmail"
                               placeholder="Start typing user email or group name..."
                               oninput="showAddUserSuggestions()"
                               onfocus="showAddUserSuggestions()"
                               autocomplete="off">
                        <div class="user-search-dropdown" id="addUserSuggestions" style="display: none;"></div>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 5px;">
                        üí° Type to search from cached users/groups, or enter email/Object ID directly
                    </p>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="newUserRole">
                        <option value="Viewer">Viewer</option>
                        <option value="Contributor">Contributor</option>
                        <option value="Member">Member</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="newUserType">
                        <option value="User">User</option>
                        <option value="Group">Group</option>
                        <option value="App">App</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddUserModal()" class="button-secondary">Cancel</button>
                <button onclick="addUser()" class="button-success">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Add Workspace Access Modal -->
    <div class="modal" id="addWorkspaceAccessModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚ûï Add Workspace Access for <span id="modalUserName"></span></h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search Workspaces</label>
                    <input type="text" id="workspaceSearchInput" 
                           placeholder="Type to filter..." oninput="filterAvailableWorkspaces()">
                </div>
                <div class="form-group">
                    <label>Available Workspaces</label>
                    <div id="availableWorkspacesList" style="max-height: 300px; overflow-y: auto; 
                         border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                        Loading...
                    </div>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="bulkWorkspaceRole">
                        <option value="Viewer">Viewer</option>
                        <option value="Contributor">Contributor</option>
                        <option value="Member">Member</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddWorkspaceAccessModal()" class="button-secondary">Cancel</button>
                <button onclick="addUserToSelectedWorkspaces()" class="button-success">Add to Selected</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let accessToken = null;
        let tokenExpiry = null;
        let currentWorkspaceId = null;
        let currentUserEmail = null; // Current authenticated user's email
        let currentUserRole = null; // Current user's role in selected workspace
        let allUsers = [];
        let allUsersById = new Map(); // O(1) lookup index for users by identifier
        let selectedUsers = new Set();
        let allWorkspaces = [];
        let pendingRoleChanges = new Map();

        // User View
        let currentView = 'workspace';
        let selectedViewUser = null;
        let userWorkspaces = [];
        let userWorkspacesById = new Map(); // O(1) lookup index for user workspaces
        let selectedWorkspacesForUser = new Set();
        let allWorkspacesCache = [];
        let searchTimeout = null;
        let suggestionTimeout = null; // Debounce timeout for autocomplete
        let knownUsers = new Map(); // Cache of users seen across workspaces
        let workspaceUserMap = new Map(); // workspaceId -> users array (full cache)
        let userCacheBuilt = false; // Flag to track if full cache is ready
        let cacheBuildingPaused = false; // Pause cache building during write operations

        // Admin panel state
        let isPowerBIAdmin = false; // Power BI Administrator status
        let adminWorkspaces = []; // All org workspaces (admin only)
        let adminWorkspaceCache = new Map(); // O(1) lookup for admin workspaces

        // Cache optimization state (all 6 proposals)
        let workspaceCacheTTL = new Map(); // workspaceId -> expiry timestamp (Proposal 4: TTL)
        let dirtyWorkspaces = new Set(); // Track workspaces needing refresh (Proposal 6: Change Events)
        let refreshDebounceTimer = null; // Debounce refresh requests (Proposal 3: Batch Debouncing)
        let backgroundSyncTimer = null; // Background sync interval (Proposal 5: Background Sync)
        const CACHE_TTL = 300000; // 5 minutes cache TTL
        const REFRESH_DEBOUNCE = 1000; // 1 second debounce for refresh batching
        const BACKGROUND_SYNC_INTERVAL = 300000; // 5 minutes background sync

        // SAFEGUARD 3: Concurrent operation lock
        let operationInProgress = false;

        // === OPTIMIZATION FUNCTIONS (6 Proposals) ===

        // Proposal 4: Check if workspace cache is expired
        function isCacheExpired(workspaceId) {
            const expiry = workspaceCacheTTL.get(workspaceId);
            return !expiry || expiry < Date.now();
        }

        // Proposal 4: Set cache with TTL
        function setCacheWithTTL(workspaceId, users) {
            workspaceUserMap.set(workspaceId, users);
            workspaceCacheTTL.set(workspaceId, Date.now() + CACHE_TTL);
        }

        // Proposal 1: Optimistic update - Add user to cache
        function optimisticAddUser(workspaceId, user, role) {
            const users = workspaceUserMap.get(workspaceId) || [];
            const newUser = {
                identifier: user.identifier || user.email,
                displayName: user.displayName || user.email,
                emailAddress: user.email || user.identifier,
                groupUserAccessRight: role,
                principalType: user.principalType || 'User'
            };
            users.push(newUser);
            setCacheWithTTL(workspaceId, users);

            // Add to known users cache
            knownUsers.set(newUser.identifier, newUser);
        }

        // Proposal 1: Optimistic update - Remove user from cache
        function optimisticRemoveUser(workspaceId, userIdentifier) {
            const users = workspaceUserMap.get(workspaceId) || [];
            const filtered = users.filter(u => u.identifier !== userIdentifier);
            setCacheWithTTL(workspaceId, filtered);
        }

        // Proposal 1: Optimistic update - Change user role in cache
        function optimisticChangeRole(workspaceId, userIdentifier, newRole) {
            const users = workspaceUserMap.get(workspaceId) || [];
            const user = users.find(u => u.identifier === userIdentifier);
            if (user) {
                user.groupUserAccessRight = newRole;
                setCacheWithTTL(workspaceId, users);
            }
        }

        // Proposal 6: Mark workspace as needing refresh
        function markWorkspaceDirty(workspaceId) {
            dirtyWorkspaces.add(workspaceId);
        }

        // Proposal 2 & 6: Selective refresh - Only reload dirty workspaces
        async function refreshDirtyWorkspaces() {
            if (dirtyWorkspaces.size === 0) return;

            const workspacesToRefresh = Array.from(dirtyWorkspaces);
            dirtyWorkspaces.clear();

            for (const wsId of workspacesToRefresh) {
                try {
                    await refreshSingleWorkspace(wsId);
                } catch (error) {
                    console.error(`Failed to refresh workspace ${wsId}:`, error);
                }
            }
        }

        // Proposal 2: Selective refresh - Reload single workspace
        async function refreshSingleWorkspace(workspaceId) {
            try {
                const response = await apiCall(`https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`);
                if (response.ok) {
                    const data = await response.json();
                    const users = data.value || [];
                    setCacheWithTTL(workspaceId, users);

                    // Update known users
                    users.forEach(user => {
                        knownUsers.set(user.identifier, user);
                    });

                    // If this is the current workspace, re-render
                    if (currentWorkspaceId === workspaceId) {
                        allUsers = users;
                        buildUserIndex();
                        updateCurrentUserRole();
                        renderUsers();
                    }
                }
            } catch (error) {
                console.error(`Error refreshing workspace ${workspaceId}:`, error);
            }
        }

        // Proposal 3: Batch debounced refresh
        function requestDebouncedRefresh() {
            clearTimeout(refreshDebounceTimer);
            refreshDebounceTimer = setTimeout(async () => {
                await refreshDirtyWorkspaces();
            }, REFRESH_DEBOUNCE);
        }

        // Proposal 5: Background sync - Check for external changes
        async function backgroundSync() {
            // SAFEGUARD 1: Don't sync if user has pending role changes
            if (pendingRoleChanges.size > 0) return;

            // SAFEGUARD 2: Don't sync if workspace is dirty (recent changes)
            if (dirtyWorkspaces.has(currentWorkspaceId)) return;

            // SAFEGUARD 3: Don't sync if operation in progress
            if (cacheBuildingPaused || operationInProgress) return;

            if (!currentWorkspaceId) return;

            // Only sync if cache is expired
            if (isCacheExpired(currentWorkspaceId)) {
                console.log('Background sync: Refreshing current workspace');
                await refreshSingleWorkspace(currentWorkspaceId);
            }
        }

        // Proposal 5: Start background sync
        function startBackgroundSync() {
            stopBackgroundSync(); // Clear any existing timer
            backgroundSyncTimer = setInterval(backgroundSync, BACKGROUND_SYNC_INTERVAL);
        }

        // Proposal 5: Stop background sync
        function stopBackgroundSync() {
            if (backgroundSyncTimer) {
                clearInterval(backgroundSyncTimer);
                backgroundSyncTimer = null;
            }
        }
        let adminSelectedWorkspaceId = null; // Selected workspace in admin mode
        let adminSelectedUser = null; // Selected user in admin mode
        let adminMode = 'workspace'; // 'workspace' or 'user'
        let adminSuggestionTimeout = null; // Debounce for admin autocomplete

        // Reusable alert element for performance
        let alertElement = null;
        let alertTimeout = null;
        let workspaceSuggestionTimeout = null;
        let userSuggestionTimeout = null;
        let addUserSuggestionTimeout = null;

        // Configuration constants
        const BATCH_SIZE = 15; // Increased from 5 for better performance
        const MAX_CACHED_USERS = 5000; // Limit for knownUsers cache
        const RATE_LIMIT_DELAY = 100; // Reduced from 200-500ms

        // ============================================
        // HELPER FUNCTIONS - Performance Optimizations
        // ============================================

        // Generic bulk operation handler to eliminate code duplication
        async function executeBulkOperation(config) {
            // SAFEGUARD 3: Prevent concurrent operations
            if (operationInProgress) {
                showAlert('Please wait for the current operation to complete', 'warning');
                return;
            }

            const {
                items,              // Array or Set of items to process
                permissionCheck,    // Function to check permissions
                confirmMessage,     // Confirmation message
                buildPayload,       // Function to build API payload
                apiCall: makeCall,  // API call function
                onSuccess,          // Callback on success
                successMessage,     // Success message template
                errorMessage,       // Error message template
                partialMessage,     // Partial success message template
                updateCache         // Optional cache update function
            } = config;

            // Check permissions
            if (permissionCheck && !permissionCheck()) {
                showAlert('You need Admin or Member role for this operation', 'error');
                return;
            }

            if (items.size === 0 && items.length === 0) return;

            // Confirm with user
            if (confirmMessage && !confirm(confirmMessage)) return;

            operationInProgress = true;
            try {

            // Convert Set to Array if needed
            const itemArray = items instanceof Set ? Array.from(items) : items;

            // Build payloads
            const payloads = [];
            for (const item of itemArray) {
                const payload = buildPayload(item);
                if (payload) payloads.push({ item, payload });
            }

            // Process in batches
            let successCount = 0;
            let failureCount = 0;
            const errors = [];

            for (let i = 0; i < payloads.length; i += BATCH_SIZE) {
                const batch = payloads.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(({ payload }) => makeCall(payload))
                );

                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        if (onSuccess) onSuccess(batch[idx].item, result.value);
                    } else {
                        failureCount++;
                        if (result.status === 'fulfilled') {
                            errors.push(result.value.statusText || 'Unknown error');
                        } else {
                            errors.push(result.reason?.message || 'Network error');
                        }
                    }
                });

                // Small delay only if more batches remain
                if (i + BATCH_SIZE < payloads.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            // Update cache if provided
            if (updateCache) {
                updateCache(successCount, failureCount);
            }

            // Show feedback
            if (failureCount === 0) {
                showAlert(successMessage.replace('{count}', successCount), 'success');
            } else if (successCount === 0) {
                showAlert(errorMessage, 'error');
            } else {
                showAlert(partialMessage.replace('{success}', successCount).replace('{failure}', failureCount), 'error');
            }

            // Log errors for debugging
            if (errors.length > 0) {
                console.error('Bulk operation errors:', errors);
            }

            return { successCount, failureCount, errors };
        } finally {
            operationInProgress = false;
        }
    }

        // Update workspace user cache in-memory (no refetch)
        function updateUserInCache(workspaceId, identifier, updates) {
            const users = workspaceUserMap.get(workspaceId);
            if (!users) return false;

            const user = users.find(u => u.identifier === identifier);
            if (user) {
                Object.assign(user, updates);
                return true;
            }
            return false;
        }

        // Remove user from cache in-memory
        function removeUserFromCache(workspaceId, identifier) {
            const users = workspaceUserMap.get(workspaceId);
            if (!users) return false;

            const index = users.findIndex(u => u.identifier === identifier);
            if (index !== -1) {
                users.splice(index, 1);
                workspaceUserMap.set(workspaceId, users);
                return true;
            }
            return false;
        }

        // Add user to cache in-memory
        function addUserToCache(workspaceId, user) {
            const users = workspaceUserMap.get(workspaceId);
            if (users) {
                users.push(user);
                workspaceUserMap.set(workspaceId, users);
            }
        }

        // Check if user matches identifier (reusable logic)
        function userMatchesIdentifier(user, targetId, targetEmail, principalType) {
            if (user.identifier === targetId) return true;
            if (user.emailAddress && targetEmail &&
                user.emailAddress.toLowerCase() === targetEmail.toLowerCase()) return true;
            if (principalType === 'Group' && user.displayName && targetEmail &&
                user.displayName.toLowerCase() === targetEmail.toLowerCase()) return true;
            return false;
        }

        // Prune cache if it exceeds size limit
        function pruneKnownUsersCache() {
            if (knownUsers.size > MAX_CACHED_USERS) {
                // Keep only the most recent MAX_CACHED_USERS entries
                const entries = Array.from(knownUsers.entries());
                const toKeep = entries.slice(-MAX_CACHED_USERS);
                knownUsers.clear();
                toKeep.forEach(([key, value]) => knownUsers.set(key, value));
                console.info(`Pruned knownUsers cache to ${MAX_CACHED_USERS} entries`);
            }
        }

        // Update button permissions (reusable UI logic)
        function updateButtonState(button, hasPermission, tooltipMessage) {
            if (!button) return;
            button.disabled = !hasPermission;
            button.style.opacity = hasPermission ? '1' : '0.5';
            button.style.cursor = hasPermission ? 'pointer' : 'not-allowed';
            button.title = hasPermission ? '' : tooltipMessage;
        }

        // Clear all timeouts on cleanup
        function clearAllTimeouts() {
            [alertTimeout, searchTimeout, suggestionTimeout,
             workspaceSuggestionTimeout, userSuggestionTimeout,
             addUserSuggestionTimeout].forEach(timeout => {
                if (timeout) clearTimeout(timeout);
            });
            alertTimeout = searchTimeout = suggestionTimeout =
            workspaceSuggestionTimeout = userSuggestionTimeout =
            addUserSuggestionTimeout = null;
        }

        // Sign out
        function signOut() {
            accessToken = null;
            tokenExpiry = null;

            // Clear all pending timeouts
            clearAllTimeouts();

            // Clear caches
            workspaceUserMap.clear();
            knownUsers.clear();
            userCacheBuilt = false;
            allWorkspacesCache = [];
            allWorkspaces = [];
            sessionStorage.removeItem('pbi_token');

            // Clear admin state
            isPowerBIAdmin = false;
            adminWorkspaces = [];
            adminWorkspaceCache.clear();
            adminSelectedWorkspaceId = null;
            adminSelectedUser = null;

            // Reset UI
            document.getElementById('authStatus').className = 'status-badge not-authenticated';
            document.getElementById('authStatus').innerHTML = '‚ö†Ô∏è Not Authenticated';
            document.getElementById('workspaceSearch').disabled = true;
            document.getElementById('searchWorkspaceBtn').disabled = true;
            document.getElementById('signOutBtn').style.display = 'none';
            clearWorkspaceSelection();

            showAlert('Signed out', 'info');
        }

        // Sign in modal
        function showManualTokenModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function copyPowerShellCommand() {
            const cmd = 'if (-not (Get-Module -ListAvailable -Name MicrosoftPowerBIMgmt)) { Write-Host "PowerBI module not found. Installing..." -ForegroundColor Yellow; Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force }; Connect-PowerBIServiceAccount; (Get-PowerBIAccessToken).Authorization.Replace("Bearer ","") | Set-Clipboard; Write-Host "Token copied!" -ForegroundColor Green';
            navigator.clipboard.writeText(cmd).then(() => {
                showAlert('PowerShell command copied! Paste in PowerShell and run.', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const el = document.getElementById('psCommand');
                const range = document.createRange();
                range.selectNodeContents(el);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                showAlert('Command selected - press Ctrl+C to copy', 'info');
            });
        }

        async function authenticateWithToken() {
            const token = document.getElementById('manualToken').value.trim();
            if (!token || !token.startsWith('eyJ')) {
                showAlert('Invalid token format', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.powerbi.com/v1.0/myorg/groups?$top=1', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    accessToken = token;
                    tokenExpiry = Date.now() + (3600 * 1000);
                    sessionStorage.setItem('pbi_token', token);

                    // Reset caches on new authentication
                    workspaceUserMap.clear();
                    knownUsers.clear();
                    userCacheBuilt = false;
                    allWorkspacesCache = [];

                    document.getElementById('authStatus').className = 'status-badge authenticated';
                    document.getElementById('authStatus').innerHTML = '‚úÖ Authenticated';
                    document.getElementById('workspaceSearch').disabled = false;
                    document.getElementById('signOutBtn').style.display = 'inline-block';

                    closeAuthModal();
                    showAlert('Authentication successful!', 'success');

                    // Get current user email from token
                    getCurrentUserFromToken(token);

                    // Check if user has admin permissions
                    await checkAdminStatus();

                    // Show/hide admin panel based on status
                    updateAdminPanelVisibility();

                    await loadWorkspaces();
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                showAlert('Authentication failed', 'error');
            }
        }

        // Get current user email from JWT token
        function getCurrentUserFromToken(token) {
            try {
                const payload = token.split('.')[1];
                const decoded = JSON.parse(atob(payload));
                currentUserEmail = decoded.upn || decoded.unique_name || decoded.email;
            } catch (error) {
                console.error('Failed to decode token:', error);
                currentUserEmail = null;
            }
        }

        // Check if current user has Power BI Administrator role
        async function checkAdminStatus() {
            try {
                // Try to call admin-only endpoint
                const response = await apiCall('https://api.powerbi.com/v1.0/myorg/admin/groups?$top=1');

                if (response.ok) {
                    isPowerBIAdmin = true;
                    console.info('‚úÖ Power BI Administrator access detected');
                    return true;
                }
            } catch (error) {
                console.info('‚ÑπÔ∏è User does not have Power BI Administrator access');
            }

            isPowerBIAdmin = false;
            return false;
        }

        // Show/hide admin panel based on admin status
        function updateAdminPanelVisibility() {
            const adminBtn = document.getElementById('adminViewBtn');
            if (isPowerBIAdmin) {
                adminBtn.style.display = 'inline-block';

                // Add admin badge to auth status
                const authStatus = document.getElementById('authStatus');
                if (!authStatus.innerHTML.includes('ADMIN')) {
                    authStatus.innerHTML += ' <span class="admin-badge">ADMIN</span>';
                }
            } else {
                adminBtn.style.display = 'none';
            }
        }

        // VIEW SWITCHER
        function switchView(view) {
            currentView = view;
            document.getElementById('workspaceView').style.display = view === 'workspace' ? 'block' : 'none';
            document.getElementById('userView').style.display = view === 'user' ? 'block' : 'none';
            document.getElementById('adminView').style.display = view === 'admin' ? 'block' : 'none';

            document.getElementById('workspaceViewBtn').classList.toggle('active', view === 'workspace');
            document.getElementById('userViewBtn').classList.toggle('active', view === 'user');
            document.getElementById('adminViewBtn').classList.toggle('active', view === 'admin');

            // Load admin workspaces when switching to admin view
            if (view === 'admin' && isPowerBIAdmin && adminWorkspaces.length === 0) {
                loadAdminWorkspaces();
            }
        }

        // Admin mode switcher (workspace vs user assignment)
        function switchAdminMode(mode) {
            adminMode = mode;
            document.getElementById('adminAssignToWorkspace').style.display = mode === 'workspace' ? 'block' : 'none';
            document.getElementById('adminAssignToUser').style.display = mode === 'user' ? 'block' : 'none';

            document.getElementById('adminModeWorkspaceBtn').classList.toggle('active', mode === 'workspace');
            document.getElementById('adminModeUserBtn').classList.toggle('active', mode === 'user');
        }

        // ============================================
        // ADMIN PANEL FUNCTIONS
        // ============================================

        // Load all organizational workspaces (admin only)
        async function loadAdminWorkspaces() {
            if (!isPowerBIAdmin) {
                showAlert('Admin access required', 'error');
                return;
            }

            try {
                showAlert('Loading all organizational workspaces...', 'info');

                // Admin endpoint to get ALL workspaces with pagination support
                let allWorkspaces = [];
                let nextLink = 'https://api.powerbi.com/v1.0/myorg/admin/groups?$top=5000';

                // Fetch all pages
                while (nextLink) {
                    const response = await apiCall(nextLink);

                    if (!response.ok) {
                        if (response.status === 403) {
                            // Permission revoked mid-session
                            isPowerBIAdmin = false;
                            updateAdminPanelVisibility();
                            switchView('workspace');
                            showAlert('Admin access revoked. Returning to normal view.', 'error');
                            return;
                        }
                        throw new Error('Failed to load admin workspaces');
                    }

                    const data = await response.json();
                    allWorkspaces = allWorkspaces.concat(data.value || []);

                    // Check for next page
                    nextLink = data['@odata.nextLink'] || null;

                    if (nextLink) {
                        showAlert(`Loading workspaces... (${allWorkspaces.length} loaded)`, 'info');
                    }
                }

                // Filter out personal workspaces (Type = "PersonalGroup" or "PersonalWorkspace" or name starts with "PersonalWorkspace")
                adminWorkspaces = allWorkspaces.filter(ws => {
                    const isPersonalType = ws.type === 'PersonalGroup' || ws.type === 'PersonalWorkspace';
                    const isPersonalName = ws.name && ws.name.startsWith('PersonalWorkspace');
                    return !isPersonalType && !isPersonalName;
                });

                // Cache by ID for quick lookup
                adminWorkspaces.forEach(ws => {
                    adminWorkspaceCache.set(ws.id, ws);
                });

                const filteredCount = allWorkspaces.length - adminWorkspaces.length;
                showAlert(`Loaded ${adminWorkspaces.length} organizational workspaces (${filteredCount} personal workspaces excluded)`, 'success');

            } catch (error) {
                console.error('Error loading admin workspaces:', error);
                showAlert('Failed to load admin workspaces', 'error');
            }
        }

        // Show workspace suggestions in admin mode (standardized pattern)
        function showAdminWorkspaceSuggestions() {
            clearTimeout(adminSuggestionTimeout);
            adminSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('adminWorkspaceSearch');
                const dropdown = document.getElementById('adminWorkspaceSuggestions');
                if (!input || !dropdown) return;

                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || adminWorkspaces.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Filter and sort workspaces
                const matches = adminWorkspaces
                    .filter(ws => ws.name && ws.name.toLowerCase().includes(searchTerm))
                    .sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()))
                    .slice(0, 20);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Build dropdown HTML
                dropdown.innerHTML = matches.map(ws => `
                    <div class="user-search-item" onclick="selectAdminWorkspace('${escapeHtml(ws.id)}')">
                        <div style="width: 32px; height: 32px; border-radius: 6px; background: #004d90; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üìÅ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${escapeHtml(ws.name)}</div>
                            <div style="font-size: 11px; color: #666;">${ws.type || 'Workspace'}</div>
                        </div>
                    </div>
                `).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        // Hide admin workspace suggestions
        function hideAdminWorkspaceSuggestions() {
            const dropdown = document.getElementById('adminWorkspaceSuggestions');
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 200);
        }

        // Select workspace in admin mode
        function selectAdminWorkspace(workspaceId) {
            const workspace = adminWorkspaceCache.get(workspaceId);
            if (!workspace) return;

            adminSelectedWorkspaceId = workspaceId;

            // Update UI
            document.getElementById('adminSelectedWorkspaceName').textContent = workspace.name;
            document.getElementById('adminSelectedWorkspaceInfo').style.display = 'block';
            document.getElementById('adminBulkAddBtn').style.display = 'inline-block';

            // Hide dropdown
            document.getElementById('adminWorkspaceSuggestions').style.display = 'none';

            // Clear search input
            document.getElementById('adminWorkspaceSearch').value = '';
        }

        // Track selected users for bulk add modal
        let adminBulkSelectedUsers = [];

        // Show bulk add modal for admin mode
        function showAdminBulkAddModal() {
            if (!adminSelectedWorkspaceId) {
                showAlert('Select a workspace first', 'error');
                return;
            }

            const workspace = adminWorkspaceCache.get(adminSelectedWorkspaceId);
            const workspaceName = workspace ? workspace.name : 'selected workspace';

            // Reset selected users
            adminBulkSelectedUsers = [];

            // Create modal with search dropdown pattern
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'adminBulkAddModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>‚ûï Add Users/Groups to ${escapeHtml(workspaceName)}</h2>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <strong>‚ö†Ô∏è Admin Mode:</strong> You can add any user/group to this workspace
                        </div>
                        <div class="form-group">
                            <label>Search Users/Groups</label>
                            <div style="position: relative;">
                                <input type="text" id="adminBulkUserSearch"
                                       placeholder="üîç Type to search users or groups..."
                                       oninput="showAdminBulkUserSuggestions()"
                                       onfocus="showAdminBulkUserSuggestions()"
                                       autocomplete="off">
                                <div id="adminBulkUserSuggestions" class="user-search-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Selected Users/Groups (<span id="adminBulkSelectedCount">0</span>)</label>
                            <div id="adminBulkSelectedList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px; min-height: 60px;">
                                <div style="text-align: center; color: #999; padding: 20px;">Search and click users/groups to add them</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="adminBulkRole">
                                <option value="Viewer">Viewer</option>
                                <option value="Contributor">Contributor</option>
                                <option value="Member">Member</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeAdminBulkAddModal()" class="button-secondary">Cancel</button>
                        <button onclick="executeAdminBulkAdd()" class="button-success">Add All</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Show user suggestions for bulk add
        function showAdminBulkUserSuggestions() {
            clearTimeout(adminSuggestionTimeout);
            adminSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('adminBulkUserSearch');
                const dropdown = document.getElementById('adminBulkUserSuggestions');
                if (!input || !dropdown) return;

                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || knownUsers.size === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Filter users/groups from known users
                const matches = Array.from(knownUsers.values())
                    .filter(user => {
                        const email = (user.email || '').toLowerCase();
                        const displayName = (user.displayName || '').toLowerCase();
                        return email.includes(searchTerm) || displayName.includes(searchTerm);
                    })
                    .slice(0, 25);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(user => `
                    <div class="user-search-item" onclick="addUserToBulkSelection('${escapeHtml(user.identifier || user.email)}', '${escapeHtml(user.displayName || user.email)}', '${user.principalType || 'User'}')">
                        <div class="user-avatar">${getInitials(user.displayName || user.email)}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${escapeHtml(user.displayName || user.email)}</div>
                            <div style="font-size: 11px; color: #666;">${escapeHtml(user.email || user.identifier)}
                                ${user.principalType === 'Group' ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">GROUP</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        // Add user to bulk selection list
        function addUserToBulkSelection(identifier, displayName, principalType) {
            // Check if already added
            if (adminBulkSelectedUsers.some(u => u.identifier === identifier)) {
                showAlert('User/group already added', 'info');
                return;
            }

            // Add to selection
            adminBulkSelectedUsers.push({ identifier, displayName, principalType });

            // Update UI
            updateAdminBulkSelectedList();

            // Clear and hide search
            document.getElementById('adminBulkUserSearch').value = '';
            document.getElementById('adminBulkUserSuggestions').style.display = 'none';
        }

        // Remove user from bulk selection
        function removeUserFromBulkSelection(identifier) {
            adminBulkSelectedUsers = adminBulkSelectedUsers.filter(u => u.identifier !== identifier);
            updateAdminBulkSelectedList();
        }

        // Update the selected users list UI
        function updateAdminBulkSelectedList() {
            const listContainer = document.getElementById('adminBulkSelectedList');
            const countSpan = document.getElementById('adminBulkSelectedCount');

            if (!listContainer || !countSpan) return;

            countSpan.textContent = adminBulkSelectedUsers.length;

            if (adminBulkSelectedUsers.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Search and click users/groups to add them</div>';
                return;
            }

            listContainer.innerHTML = adminBulkSelectedUsers.map(user => `
                <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px;">
                    <div class="user-avatar" style="margin-right: 10px;">${getInitials(user.displayName)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 13px;">${escapeHtml(user.displayName)}</div>
                        <div style="font-size: 11px; color: #666;">${escapeHtml(user.identifier)}
                            ${user.principalType === 'Group' ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">GROUP</span>' : ''}
                        </div>
                    </div>
                    <button onclick="removeUserFromBulkSelection('${escapeHtml(user.identifier)}')"
                            class="button-secondary"
                            style="padding: 5px 10px; font-size: 12px;">Remove</button>
                </div>
            `).join('');
        }

        // Close bulk add modal
        function closeAdminBulkAddModal() {
            const modal = document.getElementById('adminBulkAddModal');
            if (modal) modal.remove();
        }

        // Execute bulk add operation in admin mode
        async function executeAdminBulkAdd() {
            const role = document.getElementById('adminBulkRole').value;

            if (adminBulkSelectedUsers.length === 0) {
                showAlert('Select at least one user/group', 'error');
                return;
            }

            const userCount = adminBulkSelectedUsers.filter(u => u.principalType === 'User').length;
            const groupCount = adminBulkSelectedUsers.filter(u => u.principalType === 'Group').length;
            const summary = userCount > 0 && groupCount > 0
                ? `${userCount} user(s) and ${groupCount} group(s)`
                : userCount > 0 ? `${userCount} user(s)` : `${groupCount} group(s)`;

            if (!confirm(`Add ${summary} to workspace as ${role}?`)) {
                return;
            }

            closeAdminBulkAddModal();

            // Use bulk operation handler
            await executeBulkOperation({
                items: adminBulkSelectedUsers,
                permissionCheck: () => isPowerBIAdmin,
                confirmMessage: null, // Already confirmed
                buildPayload: (user) => ({
                    workspaceId: adminSelectedWorkspaceId,
                    user: user,
                    payload: {
                        emailAddress: user.identifier,
                        identifier: user.identifier,
                        groupUserAccessRight: role,
                        principalType: user.principalType
                    }
                }),
                apiCall: async ({ workspaceId, payload }) => {
                    return await apiCall(
                        `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`,
                        { method: 'POST', body: JSON.stringify(payload) }
                    );
                },
                successMessage: `Successfully added {count} user(s)/group(s) to workspace (Admin)`,
                errorMessage: `Failed to add users/groups to workspace`,
                partialMessage: `Added {success} user(s)/group(s), {failure} failed (Admin)`
            });
        }

        // Admin user search suggestions (standardized pattern)
        function showAdminUserSuggestions() {
            clearTimeout(adminSuggestionTimeout);
            adminSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('adminUserSearch');
                const dropdown = document.getElementById('adminUserSuggestions');
                if (!input || !dropdown) return;

                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || knownUsers.size === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Search from known users cache
                const matches = Array.from(knownUsers.values())
                    .filter(user => {
                        const email = (user.email || '').toLowerCase();
                        const displayName = (user.displayName || '').toLowerCase();
                        return email.includes(searchTerm) || displayName.includes(searchTerm);
                    })
                    .slice(0, 25);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(user => `
                    <div class="user-search-item" onclick="selectAdminUser('${escapeHtml(user.identifier || user.email)}', '${escapeHtml(user.displayName || user.email)}', '${user.principalType || 'User'}')">
                        <div class="user-avatar">${getInitials(user.displayName || user.email)}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${escapeHtml(user.displayName || user.email)}</div>
                            <div style="font-size: 11px; color: #666;">${escapeHtml(user.email || user.identifier)}
                                ${user.principalType === 'Group' ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">GROUP</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        // Hide admin user suggestions
        function hideAdminUserSuggestions() {
            const dropdown = document.getElementById('adminUserSuggestions');
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 200);
        }

        // Select user in admin mode (for mode 2)
        function selectAdminUser(identifier, displayName, principalType) {
            adminSelectedUser = {
                identifier: identifier,
                displayName: displayName,
                principalType: principalType || 'User'
            };

            // Update UI
            document.getElementById('adminSelectedUserName').textContent = displayName;
            document.getElementById('adminSelectedUserInfo').style.display = 'block';
            document.getElementById('adminBulkWorkspaceBtn').style.display = 'inline-block';

            // Hide dropdown
            document.getElementById('adminUserSuggestions').style.display = 'none';

            // Clear search input
            document.getElementById('adminUserSearch').value = '';
        }

        // Show bulk workspace assignment modal (Mode 2)
        function showAdminBulkWorkspaceModal() {
            if (!adminSelectedUser) {
                showAlert('Select a user/group first', 'error');
                return;
            }

            // Create modal with workspace selection
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'adminBulkWorkspaceModal';

            // Generate workspace checkboxes (initially all workspaces, limited to 200)
            const workspacesToShow = adminWorkspaces.slice(0, 200);

            // Debug: Log first few workspace names
            console.log('Creating modal with workspaces:', workspacesToShow.slice(0, 3).map(ws => ({ name: ws.name, lowerName: (ws.name || '').toLowerCase() })));

            const workspaceCheckboxes = workspacesToShow
                .map(ws => {
                    const lowercaseName = (ws.name || '').toLowerCase();
                    const escapedLowercaseName = escapeHtml(lowercaseName);
                    return `
                    <label class="workspace-item" data-workspace-name="${escapedLowercaseName}" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e0e0e0; cursor: pointer;">
                        <input type="checkbox" value="${escapeHtml(ws.id)}" style="margin-right: 10px; cursor: pointer;">
                        <span>${escapeHtml(ws.name)}</span>
                    </label>
                    `;
                }).join('');

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header" style="background: #ffc107; color: #000;">
                        <h2>‚ûï Add to Multiple Workspaces (Admin Mode)</h2>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 15px; background: #d4edda; border-radius: 6px; margin-bottom: 20px; border: 2px solid #28a745;">
                            <strong style="color: #155724;">‚úì Selected:</strong> <span style="color: #155724; font-weight: 600;">${escapeHtml(adminSelectedUser.displayName)}</span>
                            ${adminSelectedUser.principalType === 'Group' ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">GROUP</span>' : ''}
                        </div>

                        <div class="form-group">
                            <label>Role</label>
                            <select id="adminBulkWorkspaceRole" style="width: 100%; padding: 10px; border: 2px solid #999999; border-radius: 6px;">
                                <option value="Viewer">Viewer</option>
                                <option value="Contributor">Contributor</option>
                                <option value="Member">Member</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Search & Select Workspaces</label>
                            <input type="text" id="adminWorkspaceSearchInput"
                                   placeholder="üîç Type to filter workspaces..."
                                   oninput="filterAdminWorkspaceList()"
                                   style="width: 100%; padding: 10px; border: 2px solid #004d90; border-radius: 6px; margin-bottom: 10px;">
                            <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                                <button onclick="selectAllAdminWorkspaces(true)" class="button-secondary" style="padding: 5px 10px; font-size: 12px;">Select All Visible</button>
                                <button onclick="selectAllAdminWorkspaces(false)" class="button-secondary" style="padding: 5px 10px; font-size: 12px;">Deselect All</button>
                            </div>
                            <div id="workspaceListContainer" style="max-height: 300px; overflow-y: auto; border: 2px solid #999999; border-radius: 6px;">
                                ${workspaceCheckboxes}
                            </div>
                            <p style="font-size: 11px; color: #666; margin-top: 5px;">
                                ‚ÑπÔ∏è Showing up to 200 workspaces. Use search above to filter by name.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeAdminBulkWorkspaceModal()" class="button-secondary">Cancel</button>
                        <button onclick="executeAdminBulkWorkspaceAssignment()" class="button-success">Add to Selected</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Filter admin workspace list (copied from working filterAvailableWorkspaces pattern)
        function filterAdminWorkspaceList() {
            const searchTerm = document.getElementById('adminWorkspaceSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('#adminBulkWorkspaceModal .workspace-item');

            let visibleCount = 0;
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const matches = text.includes(searchTerm);

                if (matches) {
                    item.style.display = 'flex';
                    item.removeAttribute('data-hidden');
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                    item.setAttribute('data-hidden', 'true');
                }
            });

            // Update status message
            const modal = document.getElementById('adminBulkWorkspaceModal');
            if (modal && searchTerm !== '') {
                const statusMsg = modal.querySelector('.modal-body p[style*="font-size: 11px"]');
                if (statusMsg) {
                    statusMsg.innerHTML = `‚ÑπÔ∏è Showing <strong>${visibleCount}</strong> workspace(s) matching "<strong>${escapeHtml(searchTerm)}</strong>"`;
                    statusMsg.style.color = visibleCount > 0 ? '#004d90' : '#dc3545';
                    statusMsg.style.fontWeight = '600';
                }
            }
        }

        // Select/deselect all visible workspaces
        function selectAllAdminWorkspaces(select) {
            const modal = document.getElementById('adminBulkWorkspaceModal');
            if (!modal) return;

            // Only select/deselect visible workspace items (not hidden)
            const allItems = modal.querySelectorAll('.workspace-item');
            allItems.forEach(item => {
                // Check if item is visible (not hidden by filter)
                const isHidden = item.getAttribute('data-hidden') === 'true' || item.style.display === 'none';
                if (!isHidden) {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = select;
                }
            });
        }

        // Close bulk workspace modal
        function closeAdminBulkWorkspaceModal() {
            const modal = document.getElementById('adminBulkWorkspaceModal');
            if (modal) modal.remove();
        }

        // Execute bulk workspace assignment
        async function executeAdminBulkWorkspaceAssignment() {
            const modal = document.getElementById('adminBulkWorkspaceModal');
            if (!modal) return;

            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedWorkspaceIds = Array.from(checkboxes).map(cb => cb.value);
            const role = document.getElementById('adminBulkWorkspaceRole').value;

            if (selectedWorkspaceIds.length === 0) {
                showAlert('Select at least one workspace', 'error');
                return;
            }

            if (!confirm(`Add ${adminSelectedUser.displayName} to ${selectedWorkspaceIds.length} workspace(s) as ${role}?`)) {
                return;
            }

            closeAdminBulkWorkspaceModal();

            // Use bulk operation handler
            await executeBulkOperation({
                items: selectedWorkspaceIds,
                permissionCheck: () => isPowerBIAdmin,
                confirmMessage: null, // Already confirmed
                buildPayload: (workspaceId) => ({
                    workspaceId: workspaceId,
                    payload: {
                        emailAddress: adminSelectedUser.identifier,
                        identifier: adminSelectedUser.identifier,
                        groupUserAccessRight: role,
                        principalType: adminSelectedUser.principalType
                    }
                }),
                apiCall: async ({ workspaceId, payload }) => {
                    return await apiCall(
                        `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`,
                        { method: 'POST', body: JSON.stringify(payload) }
                    );
                },
                successMessage: `Successfully added ${adminSelectedUser.principalType.toLowerCase()} to {count} workspace(s) (Admin)`,
                errorMessage: `Failed to add ${adminSelectedUser.principalType.toLowerCase()} to workspaces`,
                partialMessage: `Added to {success} workspace(s), {failure} failed (Admin)`
            });
        }

        // WORKSPACE VIEW FUNCTIONS
        async function loadWorkspaces() {
            try {
                const response = await apiCall('https://api.powerbi.com/v1.0/myorg/groups');
                const data = await response.json();
                allWorkspaces = data.value || [];
                allWorkspacesCache = allWorkspaces; // Keep cache in sync

                // Enable search
                document.getElementById('workspaceSearch').disabled = false;
                document.getElementById('searchWorkspaceBtn').disabled = false;

                showAlert(`Loaded ${allWorkspaces.length} workspaces`, 'success');

                // Start building user cache in background
                buildUserCache();
            } catch (error) {
                showAlert('Error loading workspaces', 'error');
            }
        }

        // Build complete user cache using parallel requests
        async function buildUserCache() {
            if (userCacheBuilt || allWorkspacesCache.length === 0 || cacheBuildingPaused) return;

            const BATCH_SIZE = 15; // Process 15 workspaces in parallel for faster caching
            const total = allWorkspacesCache.length;
            let processed = 0;

            showAlert(`Building user cache... 0/${total}`, 'info');

            for (let i = 0; i < total; i += BATCH_SIZE) {
                // Check if paused during loop
                if (cacheBuildingPaused) {
                    showAlert('Cache building paused for data update', 'info');
                    return;
                }
                const batch = allWorkspacesCache.slice(i, i + BATCH_SIZE);

                // Run batch in parallel
                const results = await Promise.allSettled(
                    batch.map(async (workspace) => {
                        try {
                            const response = await apiCall(
                                `https://api.powerbi.com/v1.0/myorg/groups/${workspace.id}/users`
                            );
                            if (response.ok) {
                                const data = await response.json();
                                return { workspaceId: workspace.id, users: data.value || [] };
                            }
                            return { workspaceId: workspace.id, users: [] };
                        } catch (e) {
                            return { workspaceId: workspace.id, users: [] };
                        }
                    })
                );

                // Store results in cache
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        const { workspaceId, users } = result.value;
                        workspaceUserMap.set(workspaceId, users);
                        cacheUsersFromWorkspace(users);
                    }
                });

                processed += batch.length;

                // Update progress every few batches
                if (processed % 30 === 0 || processed === total) {
                    showAlert(`Building user cache... ${processed}/${total}`, 'info');
                }

                // Small delay between batches to avoid rate limiting
                if (i + BATCH_SIZE < total) {
                    await sleep(200);
                }
            }

            userCacheBuilt = true;
            showAlert(`User cache ready! ${workspaceUserMap.size} workspaces cached`, 'success');
        }
        
        function searchWorkspace() {
            const search = document.getElementById('workspaceSearch').value.trim();
            
            if (!search) {
                showAlert('Please enter a workspace name', 'error');
                return;
            }
            
            // Find exact match first
            let workspace = allWorkspaces.find(ws => ws.name.toLowerCase() === search.toLowerCase());
            
            if (!workspace) {
                // Find partial match
                const matches = allWorkspaces.filter(ws => 
                    ws.name.toLowerCase().includes(search.toLowerCase())
                );
                
                if (matches.length === 0) {
                    showAlert('No workspace found with that name', 'error');
                    return;
                }
                
                if (matches.length === 1) {
                    workspace = matches[0];
                } else {
                    // Multiple matches - show list
                    let message = `Found ${matches.length} workspaces:\n\n`;
                    matches.slice(0, 10).forEach((ws, i) => {
                        message += `${i + 1}. ${ws.name}\n`;
                    });
                    if (matches.length > 10) {
                        message += `\n...and ${matches.length - 10} more`;
                    }
                    message += '\n\nPlease be more specific.';
                    alert(message);
                    return;
                }
            }
            
            // Select the workspace
            selectWorkspace(workspace);
        }
        
        async function selectWorkspace(workspace) {
            currentWorkspaceId = workspace.id;
            document.getElementById('workspaceSearch').value = '';
            document.getElementById('selectedWorkspaceInfo').style.display = 'block';
            document.getElementById('selectedWorkspaceName').textContent = workspace.name;
            document.getElementById('workspaceInfo').textContent = workspace.name;
            document.getElementById('addUserBtn').style.display = 'block';

            showAlert('Loading users...', 'info');
            await loadWorkspaceUsers();

            // OPTIMIZATION 5: Start background sync for this workspace
            startBackgroundSync();
        }

        function clearWorkspaceSelection() {
            // OPTIMIZATION 5: Stop background sync when no workspace selected
            stopBackgroundSync();

            currentWorkspaceId = null;
            allUsers = [];
            selectedUsers.clear();
            pendingRoleChanges.clear();
            document.getElementById('workspaceSearch').value = '';
            document.getElementById('selectedWorkspaceInfo').style.display = 'none';
            document.getElementById('workspaceInfo').textContent = 'Users & Permissions';
            document.getElementById('addUserBtn').style.display = 'none';
            document.getElementById('userTableBody').innerHTML = '<tr><td colspan="6" class="empty-state"><div style="padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div><p>Enter a workspace name above to view and manage users</p></div></td></tr>';
            document.getElementById('pendingChangesContainer').style.display = 'none';
        }
        
        async function loadWorkspaceUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div></td></tr>';

            try {
                // OPTIMIZATION 4: Check if we have valid cached data (not expired)
                if (workspaceUserMap.has(currentWorkspaceId) && !isCacheExpired(currentWorkspaceId)) {
                    allUsers = workspaceUserMap.get(currentWorkspaceId);
                    buildUserIndex();
                    updateCurrentUserRole();
                    renderUsers();
                    return;
                }

                // Otherwise fetch from API
                const response = await apiCall(`https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users`);
                const data = await response.json();
                allUsers = data.value || [];

                // Build O(1) lookup index
                buildUserIndex();

                // OPTIMIZATION 4: Update cache with TTL
                setCacheWithTTL(currentWorkspaceId, allUsers);
                cacheUsersFromWorkspace(allUsers);

                // Determine current user's role in this workspace
                updateCurrentUserRole();

                renderUsers();
            } catch (error) {
                showAlert('Error loading users', 'error');
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Error loading users</td></tr>';
            }
        }

        // Build O(1) lookup index for users
        function buildUserIndex() {
            allUsersById.clear();
            allUsers.forEach(user => allUsersById.set(user.identifier, user));
        }

        // Update current user's role in the selected workspace
        function updateCurrentUserRole() {
            currentUserRole = null;
            if (!currentUserEmail || !allUsers) return;

            // Find current user in workspace users list (direct assignment)
            const currentUser = allUsers.find(user =>
                user.emailAddress?.toLowerCase() === currentUserEmail.toLowerCase() ||
                user.identifier?.toLowerCase() === currentUserEmail.toLowerCase()
            );

            if (currentUser) {
                currentUserRole = currentUser.groupUserAccessRight;
            }

            // Check if there are groups with Admin/Member permissions
            const groups = allUsers.filter(u => u.principalType === 'Group');
            const adminOrMemberGroups = groups.filter(g =>
                g.groupUserAccessRight === 'Admin' || g.groupUserAccessRight === 'Member'
            );

            // Show warning if groups exist and user doesn't have direct permissions
            const warningDiv = document.getElementById('groupPermissionsWarning');
            if (warningDiv) {
                if (adminOrMemberGroups.length > 0 && !currentUserRole) {
                    warningDiv.style.display = 'block';
                    console.info('Groups with Admin/Member permissions in this workspace:',
                        adminOrMemberGroups.map(g => g.displayName || g.identifier));
                } else {
                    warningDiv.style.display = 'none';
                }
            }

            // Update UI based on permissions
            updateUIPermissions();
        }

        // Test actual permissions by attempting to read workspace users
        async function testWorkspacePermissions() {
            if (!currentWorkspaceId) return false;

            try {
                // Attempt to read workspace users - this requires at least Viewer access
                const response = await apiCall(
                    `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users`
                );

                if (response.ok) {
                    // If we can read users, we have at least Viewer access
                    // For write operations, the actual API calls will validate permissions
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Permission test failed:', error);
                return false;
            }
        }

        // Check if current user can edit workspace (Admin or Member role required)
        function canEditWorkspace() {
            // If user has direct permissions, check them
            if (currentUserRole) {
                return currentUserRole === 'Admin' || currentUserRole === 'Member';
            }

            // If no direct permissions but groups exist with Admin/Member role,
            // assume user might have permissions through group membership
            // The actual API calls will validate permissions on the backend
            if (allUsers) {
                const adminOrMemberGroups = allUsers.filter(u =>
                    u.principalType === 'Group' &&
                    (u.groupUserAccessRight === 'Admin' || u.groupUserAccessRight === 'Member')
                );

                // If such groups exist, allow UI actions (backend will validate)
                if (adminOrMemberGroups.length > 0) {
                    return true;
                }
            }

            return false;
        }

        // Check if current user can edit a specific workspace by ID
        function canEditWorkspaceById(workspaceId) {
            if (!currentUserEmail || !workspaceId) return false;

            // Get users for this workspace from cache
            const users = workspaceUserMap.get(workspaceId);
            if (!users) return false;

            // Find current user in workspace users (direct assignment)
            const currentUser = users.find(user =>
                user.emailAddress?.toLowerCase() === currentUserEmail.toLowerCase() ||
                user.identifier?.toLowerCase() === currentUserEmail.toLowerCase()
            );

            if (currentUser) {
                // Check if user has Admin or Member role
                const role = currentUser.groupUserAccessRight;
                return role === 'Admin' || role === 'Member';
            }

            // Check if there are groups with Admin/Member permissions
            // User might have permissions through group membership
            const adminOrMemberGroups = users.filter(u =>
                u.principalType === 'Group' &&
                (u.groupUserAccessRight === 'Admin' || u.groupUserAccessRight === 'Member')
            );

            // If such groups exist, allow UI actions (backend API will validate actual permissions)
            if (adminOrMemberGroups.length > 0) {
                return true;
            }

            return false;
        }

        // Update UI elements based on user permissions
        function updateUIPermissions() {
            const hasEditPermission = canEditWorkspace();

            // Add User button
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.disabled = !hasEditPermission;
                addUserBtn.style.opacity = hasEditPermission ? '1' : '0.5';
                addUserBtn.style.cursor = hasEditPermission ? 'pointer' : 'not-allowed';
                addUserBtn.title = hasEditPermission ? '' : 'You need Admin or Member role to manage users';
            }

            // Bulk action buttons
            const bulkButtons = document.querySelectorAll('#bulkActionsContainer button');
            bulkButtons.forEach(btn => {
                btn.disabled = !hasEditPermission;
                btn.style.opacity = hasEditPermission ? '1' : '0.5';
                btn.style.cursor = hasEditPermission ? 'pointer' : 'not-allowed';
                if (!hasEditPermission) {
                    btn.title = 'You need Admin or Member role to manage users';
                }
            });

            // Apply/Cancel pending changes buttons
            const applyBtn = document.querySelector('[onclick="applyPendingRoleChanges()"]');
            const cancelBtn = document.querySelector('[onclick="cancelPendingRoleChanges()"]');
            if (applyBtn) {
                applyBtn.disabled = !hasEditPermission;
                applyBtn.style.opacity = hasEditPermission ? '1' : '0.5';
                applyBtn.style.cursor = hasEditPermission ? 'pointer' : 'not-allowed';
                if (!hasEditPermission) {
                    applyBtn.title = 'You need Admin or Member role to apply changes';
                }
            }
            if (cancelBtn) {
                cancelBtn.disabled = !hasEditPermission;
                cancelBtn.style.opacity = hasEditPermission ? '1' : '0.5';
                cancelBtn.style.cursor = hasEditPermission ? 'pointer' : 'not-allowed';
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
                return;
            }

            // Sort users alphabetically by displayName (fallback to emailAddress)
            const sortedUsers = [...allUsers].sort((a, b) => {
                const nameA = (a.displayName || a.emailAddress || '').toLowerCase();
                const nameB = (b.displayName || b.emailAddress || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });

            // Use DocumentFragment for batch DOM insertion
            const fragment = document.createDocumentFragment();

            const hasEditPermission = canEditWorkspace();

            sortedUsers.forEach(user => {
                const tr = document.createElement('tr');
                const initials = getInitials(user.displayName || user.emailAddress);
                const currentRole = user.groupUserAccessRight || 'Viewer';
                const pendingRole = pendingRoleChanges.get(user.identifier);
                const displayRole = pendingRole || currentRole;
                const escapedIdentifier = escapeHtml(user.identifier);

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" data-action="toggle-user" data-identifier="${escapedIdentifier}"
                               ${selectedUsers.has(user.identifier) ? 'checked' : ''}
                               ${!hasEditPermission ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="user-avatar">${initials}</div>
                            <strong>${escapeHtml(user.displayName || user.emailAddress)}</strong>
                        </div>
                    </td>
                    <td>${escapeHtml(user.emailAddress || user.identifier)}</td>
                    <td>
                        <span class="role-badge role-${currentRole.toLowerCase()}">${currentRole}</span>
                        ${pendingRole ? `<div style="margin-top: 4px; color: #ff6b00; font-weight: 600;">‚Üí ${pendingRole}</div>` : ''}
                    </td>
                    <td>
                        <div style="display: flex; gap: 10px;">
                            ${['Admin', 'Member', 'Contributor', 'Viewer'].map(role => `
                                <label style="display: flex; align-items: center; gap: 4px; cursor: ${hasEditPermission ? 'pointer' : 'not-allowed'}; opacity: ${hasEditPermission ? '1' : '0.5'};" title="${!hasEditPermission ? 'You need Admin or Member role to change roles' : ''}">
                                    <input type="radio" name="role-${user.identifier}" value="${role}"
                                           data-action="stage-role" data-identifier="${escapedIdentifier}" data-role="${role}"
                                           ${displayRole === role ? 'checked' : ''}
                                           ${!hasEditPermission ? 'disabled' : ''}>
                                    <span style="font-size: 13px;">${role}</span>
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <button data-action="remove-user" data-identifier="${escapedIdentifier}" class="button-danger"
                                style="padding: 6px 12px; font-size: 13px; opacity: ${hasEditPermission ? '1' : '0.5'}; cursor: ${hasEditPermission ? 'pointer' : 'not-allowed'};"
                                ${!hasEditPermission ? 'disabled title="You need Admin or Member role to remove users"' : ''}>üóëÔ∏è</button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
        }
        
        function toggleUserSelection(identifier) {
            if (selectedUsers.has(identifier)) {
                selectedUsers.delete(identifier);
            } else {
                selectedUsers.add(identifier);
            }
            updateWorkspaceBulkActions();
        }
        
        function toggleSelectAll(checked) {
            selectedUsers.clear();
            if (checked) {
                allUsers.forEach(u => selectedUsers.add(u.identifier));
            }
            updateWorkspaceBulkActions();
            renderUsers();
        }
        
        function updateWorkspaceBulkActions() {
            const div = document.getElementById('workspaceBulkActions');
            const count = selectedUsers.size;
            
            if (count > 0) {
                div.style.display = 'flex';
                document.getElementById('selectedUsersCount').textContent = `${count} selected`;
            } else {
                div.style.display = 'none';
            }
        }
        
        async function bulkSetRole(newRole) {
            // Check permission first
            if (!canEditWorkspace()) {
                showAlert('You need Admin or Member role to change roles', 'error');
                return;
            }

            if (selectedUsers.size === 0) return;

            if (!confirm(`Set role to ${newRole} for ${selectedUsers.size} user(s)?`)) return;

            // Build payloads using O(1) Map lookup
            const payloads = [];
            const identifiersToUpdate = [];
            for (const identifier of selectedUsers) {
                const user = allUsersById.get(identifier);
                if (!user) continue;
                payloads.push({
                    groupUserAccessRight: newRole,
                    principalType: user.principalType || 'User',
                    identifier: user.identifier,
                    emailAddress: user.emailAddress || user.identifier
                });
                identifiersToUpdate.push(identifier);
            }

            // Process in parallel batches
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < payloads.length; i += BATCH_SIZE) {
                const batch = payloads.slice(i, i + BATCH_SIZE);
                const batchIdentifiers = identifiersToUpdate.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(payload =>
                        apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users`,
                            { method: 'PUT', body: JSON.stringify(payload) }
                        )
                    )
                );

                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        // Update cache in-memory instead of refetching
                        updateUserInCache(currentWorkspaceId, batchIdentifiers[idx], {
                            groupUserAccessRight: newRole
                        });
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < payloads.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            selectedUsers.clear();
            updateWorkspaceBulkActions();

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully changed ${successCount} role(s) to ${newRole}`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to change roles`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: ${successCount} changed, ${failureCount} failed`, 'error');
            }

            // Re-render with updated cache (no API call needed!)
            buildUserIndex();
            renderUsers();
        }

        async function bulkRemoveUsers() {
            // Check permission first
            if (!canEditWorkspace()) {
                showAlert('You need Admin or Member role to remove users', 'error');
                return;
            }

            if (selectedUsers.size === 0) return;

            if (!confirm(`Remove ${selectedUsers.size} user(s) from this workspace?`)) return;

            const identifiers = Array.from(selectedUsers);
            let successCount = 0;
            let failureCount = 0;

            // Process in parallel batches
            for (let i = 0; i < identifiers.length; i += BATCH_SIZE) {
                const batch = identifiers.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(identifier =>
                        apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users/${encodeURIComponent(identifier)}`,
                            { method: 'DELETE' }
                        )
                    )
                );

                // Collect successes and failures
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        // Remove from cache in-memory
                        removeUserFromCache(currentWorkspaceId, batch[idx]);
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < identifiers.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            selectedUsers.clear();
            updateWorkspaceBulkActions();

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully removed ${successCount} user(s)`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to remove users`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: ${successCount} removed, ${failureCount} failed`, 'error');
            }

            // Re-render with updated cache (no API call needed!)
            buildUserIndex();
            renderUsers();

            // Update known users cache
            cacheBuildingPaused = true;
            updateKnownUsersCacheForWorkspace(currentWorkspaceId, allUsers);
            cacheBuildingPaused = false;
        }

        function stageRoleChange(identifier, newRole) {
            const user = allUsersById.get(identifier);
            if (!user) return;
            const currentRole = user.groupUserAccessRight || 'Viewer';

            if (newRole === currentRole) {
                pendingRoleChanges.delete(identifier);
            } else {
                pendingRoleChanges.set(identifier, newRole);
            }

            updatePendingChangesUI();
            renderUsers();
        }
        
        function updatePendingChangesUI() {
            const container = document.getElementById('pendingChangesContainer');
            const count = pendingRoleChanges.size;

            if (count > 0) {
                container.style.display = 'block';
                document.getElementById('pendingChangesCount').textContent = count;

                const htmlParts = [];
                pendingRoleChanges.forEach((newRole, identifier) => {
                    const user = allUsersById.get(identifier);
                    if (user) {
                        const currentRole = user.groupUserAccessRight || 'Viewer';
                        htmlParts.push(`<div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${escapeHtml(user.displayName || user.emailAddress)}</strong>:
                            ${currentRole} ‚Üí <span style="color: #ff6b00; font-weight: 600;">${newRole}</span>
                        </div>`);
                    }
                });
                document.getElementById('pendingChangesList').innerHTML = htmlParts.join('');
            } else {
                container.style.display = 'none';
            }
        }
        
        async function applyPendingRoleChanges() {
            // Check permission first
            if (!canEditWorkspace()) {
                showAlert('You need Admin or Member role to apply changes', 'error');
                return;
            }

            if (pendingRoleChanges.size === 0) return;

            if (!confirm(`Apply ${pendingRoleChanges.size} role change(s)?`)) return;

            // Build payloads using O(1) Map lookup
            const payloads = [];
            const identifiersToRoles = [];
            for (const [identifier, newRole] of pendingRoleChanges.entries()) {
                const user = allUsersById.get(identifier);
                if (!user) continue;
                payloads.push({
                    groupUserAccessRight: newRole,
                    principalType: user.principalType || 'User',
                    identifier: user.identifier,
                    emailAddress: user.emailAddress || user.identifier
                });
                identifiersToRoles.push({ identifier, newRole });
            }

            // Process in parallel batches
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < payloads.length; i += BATCH_SIZE) {
                const batch = payloads.slice(i, i + BATCH_SIZE);
                const batchIdentifiers = identifiersToRoles.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(payload =>
                        apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users`,
                            { method: 'PUT', body: JSON.stringify(payload) }
                        )
                    )
                );

                // Collect successes and failures
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        // Update cache in-memory
                        const { identifier, newRole } = batchIdentifiers[idx];
                        updateUserInCache(currentWorkspaceId, identifier, {
                            groupUserAccessRight: newRole
                        });
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < payloads.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            pendingRoleChanges.clear();
            updatePendingChangesUI();

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully applied ${successCount} change(s)`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to apply changes`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: ${successCount} applied, ${failureCount} failed`, 'error');
            }

            // Re-render with updated cache (no API call needed!)
            buildUserIndex();
            renderUsers();

            // OPTIMIZATION 4 & 6: Update TTL and mark for verification
            if (successCount > 0) {
                workspaceCacheTTL.set(currentWorkspaceId, Date.now() + CACHE_TTL);
                markWorkspaceDirty(currentWorkspaceId);
                requestDebouncedRefresh();
            }
        }

        function cancelPendingRoleChanges() {
            if (!confirm(`Cancel ${pendingRoleChanges.size} pending change(s)?`)) return;
            
            pendingRoleChanges.clear();
            updatePendingChangesUI();
            renderUsers();
            showAlert('Changes cancelled', 'info');
        }
        
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserType').value = 'User';
            document.getElementById('addUserSuggestions').style.display = 'none';
        }

        // Add user suggestions with debouncing
        function showAddUserSuggestions() {
            clearTimeout(addUserSuggestionTimeout);
            addUserSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('newUserEmail');
                const dropdown = document.getElementById('addUserSuggestions');
                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || knownUsers.size === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = Array.from(knownUsers.values())
                    .filter(user =>
                        (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm))
                    )
                    .sort((a, b) => {
                        const nameA = (a.displayName || a.email || '').toLowerCase();
                        const nameB = (b.displayName || b.email || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    })
                    .slice(0, 10);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(user => {
                    const isGroup = user.principalType === 'Group';
                    const avatarStyle = isGroup
                        ? 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%);'
                        : '';
                    const avatarContent = isGroup ? 'üë•' : getInitials(user.displayName);
                    const typeLabel = isGroup
                        ? '<span style="background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Group</span>'
                        : '';

                    return `
                        <div class="user-search-item" onclick="selectAddUserSuggestion('${escapeHtml(user.email || user.identifier)}', '${user.principalType || 'User'}')">
                            <div class="user-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${escapeHtml(user.displayName)}${typeLabel}</div>
                                <div style="font-size: 11px; color: #666;">${escapeHtml(user.email || user.identifier)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        function selectAddUserSuggestion(identifier, principalType) {
            document.getElementById('newUserEmail').value = identifier;
            document.getElementById('newUserType').value = principalType;
            document.getElementById('addUserSuggestions').style.display = 'none';
        }

        async function addUser() {
            // SAFEGUARD 3: Prevent concurrent operations
            if (operationInProgress) {
                showAlert('Please wait for the current operation to complete', 'warning');
                return;
            }

            // Check permission first
            if (!canEditWorkspace()) {
                showAlert('You need Admin or Member role to add users', 'error');
                return;
            }

            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            const type = document.getElementById('newUserType').value;

            if (!email) {
                showAlert('Enter email or object ID', 'error');
                return;
            }

            operationInProgress = true;
            try {
                const payload = {
                    emailAddress: email,
                    identifier: email,
                    groupUserAccessRight: role,
                    principalType: type
                };

                const response = await apiCall(
                    `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users`,
                    { method: 'POST', body: JSON.stringify(payload) }
                );

                if (response.ok) {
                    showAlert('User added', 'success');
                    closeAddUserModal();

                    // OPTIMIZATION 1: Optimistic update - update cache immediately
                    optimisticAddUser(currentWorkspaceId, {
                        identifier: email,
                        email: email,
                        displayName: email,
                        principalType: type
                    }, role);

                    // Update current view
                    allUsers = workspaceUserMap.get(currentWorkspaceId);
                    buildUserIndex();
                    updateCurrentUserRole();
                    renderUsers();

                    // OPTIMIZATION 6: Mark as dirty for background verification
                    markWorkspaceDirty(currentWorkspaceId);
                    requestDebouncedRefresh();
                } else {
                    throw new Error('Failed to add user');
                }
            } catch (error) {
                showAlert('Failed to add user', 'error');
                // On error, force refresh to get accurate state
                workspaceUserMap.delete(currentWorkspaceId);
                await loadWorkspaceUsers();
            } finally {
                operationInProgress = false;
            }
        }

        async function removeUser(identifier) {
            // SAFEGUARD 3: Prevent concurrent operations
            if (operationInProgress) {
                showAlert('Please wait for the current operation to complete', 'warning');
                return;
            }

            // Check permission first
            if (!canEditWorkspace()) {
                showAlert('You need Admin or Member role to remove users', 'error');
                return;
            }

            const user = allUsersById.get(identifier);
            if (!user || !confirm(`Remove ${user.displayName || user.emailAddress}?`)) return;

            operationInProgress = true;
            try {
                const response = await apiCall(
                    `https://api.powerbi.com/v1.0/myorg/groups/${currentWorkspaceId}/users/${encodeURIComponent(identifier)}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    showAlert('User removed', 'success');

                    // OPTIMIZATION 1: Optimistic update - remove from cache immediately
                    optimisticRemoveUser(currentWorkspaceId, identifier);

                    // Update current view
                    allUsers = workspaceUserMap.get(currentWorkspaceId);
                    buildUserIndex();
                    updateCurrentUserRole();
                    renderUsers();

                    // OPTIMIZATION 6: Mark as dirty for background verification
                    markWorkspaceDirty(currentWorkspaceId);
                    requestDebouncedRefresh();
                }
            } catch (error) {
                showAlert('Failed to remove user', 'error');
                // On error, force refresh to get accurate state
                workspaceUserMap.delete(currentWorkspaceId);
                await loadWorkspaceUsers();
            } finally {
                operationInProgress = false;
            }
        }

        // USER VIEW FUNCTIONS
        async function searchUserByEmail() {
            const input = document.getElementById('userViewEmailInput');
            const identifier = input.value.trim();
            const principalType = input.dataset.principalType || 'User';
            const storedDisplayName = input.dataset.displayName || '';

            if (!identifier) {
                showAlert('Please enter an email address or group name', 'error');
                return;
            }

            // For users, require @ in email; for groups, allow any identifier
            const isGroup = principalType === 'Group' || !identifier.includes('@');

            if (!isGroup && !identifier.includes('@')) {
                showAlert('Please enter a valid email address', 'error');
                return;
            }

            // Create user/group object
            let displayName;
            if (storedDisplayName) {
                displayName = storedDisplayName;
            } else if (identifier.includes('@')) {
                displayName = identifier.split('@')[0].replace(/[._]/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            } else {
                displayName = identifier;
            }

            selectedViewUser = {
                id: identifier,
                displayName: displayName,
                email: identifier,
                principalType: isGroup ? 'Group' : 'User'
            };

            // Show selected user/group
            document.getElementById('selectedUserPanel').style.display = 'block';
            document.getElementById('selectedUserPanelName').innerHTML = selectedViewUser.displayName +
                (isGroup ? ' <span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Group</span>' : '');
            document.getElementById('selectedUserPanelEmail').textContent = selectedViewUser.email;

            // Clear stored data
            input.dataset.principalType = '';
            input.dataset.displayName = '';

            // Load workspaces
            await loadUserWorkspaces();
        }
        
        async function searchUsersForView() {
            const searchTerm = document.getElementById('userViewSearch').value.trim();
            
            if (searchTerm.length < 2) {
                document.getElementById('userViewSearchResults').style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const query = searchTerm.includes('@') 
                        ? `startswith(mail,'${searchTerm}') or startswith(userPrincipalName,'${searchTerm}')`
                        : `startswith(displayName,'${searchTerm}')`;
                    
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/users?$filter=${encodeURIComponent(query)}&$top=20&$select=id,displayName,mail,userPrincipalName`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        displayUserViewSearchResults(data.value);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }
        
        function displayUserViewSearchResults(users) {
            const container = document.getElementById('userViewSearchResults');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No users found</div>';
                container.style.display = 'block';
                return;
            }
            
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-search-item';
                div.onclick = () => selectUserForView(user);
                div.innerHTML = `
                    <div class="user-avatar">${getInitials(user.displayName)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${escapeHtml(user.displayName)}</div>
                        <div style="font-size: 12px; color: #666;">${escapeHtml(user.mail || user.userPrincipalName)}</div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            container.style.display = 'block';
        }
        
        async function selectUserForView(user) {
            selectedViewUser = {
                id: user.id,
                displayName: user.displayName,
                email: user.mail || user.userPrincipalName
            };
            
            document.getElementById('userViewSearch').value = '';
            document.getElementById('userViewSearchResults').style.display = 'none';
            document.getElementById('selectedUserPanel').style.display = 'block';
            document.getElementById('selectedUserPanelAvatar').textContent = getInitials(user.displayName);
            document.getElementById('selectedUserPanelName').textContent = user.displayName;
            document.getElementById('selectedUserPanelEmail').textContent = selectedViewUser.email;
            
            await loadUserWorkspaces();
        }
        
        async function loadUserWorkspaces() {
            const tbody = document.getElementById('userWorkspacesTable');
            tbody.innerHTML = '<tr><td colspan="5"><div class="loading-spinner"></div></td></tr>';

            showAlert('Loading workspace access...', 'info');

            try {
                if (allWorkspacesCache.length === 0) {
                    const response = await apiCall('https://api.powerbi.com/v1.0/myorg/groups');
                    const data = await response.json();
                    allWorkspacesCache = data.value || [];
                }

                userWorkspaces = [];

                // If cache is ready, use it for instant lookup
                if (userCacheBuilt) {
                    showAlert('Using cached data...', 'info');

                    allWorkspacesCache.forEach(workspace => {
                        const users = workspaceUserMap.get(workspace.id) || [];
                        const userAccess = users.find(u => {
                            // Match by identifier
                            if (u.identifier === selectedViewUser.id) return true;
                            // Match by email (case-insensitive)
                            if (u.emailAddress && u.emailAddress.toLowerCase() === selectedViewUser.email.toLowerCase()) return true;
                            // Match groups by displayName (case-insensitive)
                            if (selectedViewUser.principalType === 'Group' && u.displayName &&
                                u.displayName.toLowerCase() === selectedViewUser.displayName.toLowerCase()) return true;
                            return false;
                        });

                        if (userAccess) {
                            userWorkspaces.push({
                                id: workspace.id,
                                name: workspace.name,
                                type: workspace.type || 'Workspace',
                                userRole: userAccess.groupUserAccessRight
                            });
                        }
                    });
                } else {
                    // Cache not ready - use parallel loading
                    await loadUserWorkspacesParallel();
                }

                // Build O(1) lookup index for user workspaces
                buildUserWorkspacesIndex();

                document.getElementById('workspaceCount').textContent = userWorkspaces.length;
                document.getElementById('userWorkspacesContainer').style.display = 'block';
                renderUserWorkspaces();
                updateAddWorkspaceAccessButton();
                showAlert(`Found ${userWorkspaces.length} workspaces`, 'success');
            } catch (error) {
                showAlert('Failed to load workspaces', 'error');
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading workspaces</td></tr>';
            }
        }

        // Parallel loading fallback when cache isn't ready
        async function loadUserWorkspacesParallel() {
            const BATCH_SIZE = 15;
            const total = allWorkspacesCache.length;

            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = allWorkspacesCache.slice(i, i + BATCH_SIZE);

                showAlert(`Checking... ${i}/${total}`, 'info');

                // Run batch in parallel
                const results = await Promise.allSettled(
                    batch.map(async (workspace) => {
                        try {
                            const response = await apiCall(
                                `https://api.powerbi.com/v1.0/myorg/groups/${workspace.id}/users`
                            );
                            if (response.ok) {
                                const data = await response.json();
                                return { workspace, users: data.value || [] };
                            }
                            return { workspace, users: [] };
                        } catch (e) {
                            return { workspace, users: [] };
                        }
                    })
                );

                // Process results
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        const { workspace, users } = result.value;

                        // Also populate the cache as we go
                        workspaceUserMap.set(workspace.id, users);
                        cacheUsersFromWorkspace(users);

                        const userAccess = users.find(u => {
                            // Match by identifier
                            if (u.identifier === selectedViewUser.id) return true;
                            // Match by email (case-insensitive)
                            if (u.emailAddress && u.emailAddress.toLowerCase() === selectedViewUser.email.toLowerCase()) return true;
                            // Match groups by displayName (case-insensitive)
                            if (selectedViewUser.principalType === 'Group' && u.displayName &&
                                u.displayName.toLowerCase() === selectedViewUser.displayName.toLowerCase()) return true;
                            return false;
                        });

                        if (userAccess) {
                            userWorkspaces.push({
                                id: workspace.id,
                                name: workspace.name,
                                type: workspace.type || 'Workspace',
                                userRole: userAccess.groupUserAccessRight
                            });
                        }
                    }
                });

                // Small delay between batches to avoid rate limiting
                if (i + BATCH_SIZE < total) {
                    await sleep(200);
                }
            }

            // Mark cache as built if we completed the full scan
            if (workspaceUserMap.size === allWorkspacesCache.length) {
                userCacheBuilt = true;
            }
        }
        
        // Build O(1) lookup index for user workspaces
        function buildUserWorkspacesIndex() {
            userWorkspacesById.clear();
            userWorkspaces.forEach(ws => userWorkspacesById.set(ws.id, ws));
        }

        function renderUserWorkspaces() {
            const tbody = document.getElementById('userWorkspacesTable');
            tbody.innerHTML = '';

            if (userWorkspaces.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No workspace access found</td></tr>';
                return;
            }

            // Sort workspaces alphabetically by name
            const sortedWorkspaces = [...userWorkspaces].sort((a, b) => {
                return (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase());
            });

            // Use DocumentFragment for batch DOM insertion
            const fragment = document.createDocumentFragment();

            sortedWorkspaces.forEach(ws => {
                const tr = document.createElement('tr');
                const isSelected = selectedWorkspacesForUser.has(ws.id);
                const escapedId = escapeHtml(ws.id);

                // Check if current user has edit permission for this workspace
                const hasEditPermission = canEditWorkspaceById(ws.id);

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" data-action="toggle-workspace" data-workspace-id="${escapedId}"
                               ${isSelected ? 'checked' : ''}
                               ${!hasEditPermission ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    </td>
                    <td><strong>${escapeHtml(ws.name)}</strong></td>
                    <td><span class="role-badge role-${ws.userRole.toLowerCase()}">${ws.userRole}</span></td>
                    <td>${ws.type}</td>
                    <td>
                        <button data-action="change-workspace-role" data-workspace-id="${escapedId}"
                                style="background: #17a2b8; padding: 6px 12px; opacity: ${hasEditPermission ? '1' : '0.5'}; cursor: ${hasEditPermission ? 'pointer' : 'not-allowed'};"
                                ${!hasEditPermission ? 'disabled title="You need Admin or Member role in this workspace to change roles"' : ''}>‚úèÔ∏è Change</button>
                        <button data-action="remove-from-workspace" data-workspace-id="${escapedId}" class="button-danger"
                                style="padding: 6px 12px; opacity: ${hasEditPermission ? '1' : '0.5'}; cursor: ${hasEditPermission ? 'pointer' : 'not-allowed'};"
                                ${!hasEditPermission ? 'disabled title="You need Admin or Member role in this workspace to remove users"' : ''}>üóëÔ∏è</button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
            updateUserBulkActions();
        }
        
        function toggleWorkspaceSelection(workspaceId) {
            if (selectedWorkspacesForUser.has(workspaceId)) {
                selectedWorkspacesForUser.delete(workspaceId);
            } else {
                selectedWorkspacesForUser.add(workspaceId);
            }
            updateUserBulkActions();
        }
        
        function toggleAllUserWorkspaces(checked) {
            selectedWorkspacesForUser.clear();
            if (checked) {
                userWorkspaces.forEach(ws => selectedWorkspacesForUser.add(ws.id));
            }
            renderUserWorkspaces();
        }
        
        function updateUserBulkActions() {
            const div = document.getElementById('userBulkActions');
            const count = selectedWorkspacesForUser.size;

            if (count > 0) {
                div.style.display = 'flex';
                document.getElementById('selectedWorkspacesCount').textContent = `${count} selected`;

                // Check if user has permission for at least one selected workspace
                const hasAnyPermission = Array.from(selectedWorkspacesForUser).some(wsId => canEditWorkspaceById(wsId));

                // Disable bulk action buttons if no permissions
                const bulkButtons = div.querySelectorAll('button');
                bulkButtons.forEach(btn => {
                    btn.disabled = !hasAnyPermission;
                    btn.style.opacity = hasAnyPermission ? '1' : '0.5';
                    btn.style.cursor = hasAnyPermission ? 'pointer' : 'not-allowed';
                    if (!hasAnyPermission) {
                        btn.title = 'You need Admin or Member role in selected workspaces to perform this action';
                    }
                });
            } else {
                div.style.display = 'none';
            }
        }
        
        async function changeUserWorkspaceRole(workspaceId) {
            // Check permission first
            if (!canEditWorkspaceById(workspaceId)) {
                showAlert('You need Admin or Member role in this workspace', 'error');
                return;
            }

            const workspace = userWorkspacesById.get(workspaceId);
            if (!workspace) return;
            const newRole = prompt(`Change role from ${workspace.userRole} to:\nEnter: Admin, Member, Contributor, or Viewer`, workspace.userRole);

            if (!newRole || newRole === workspace.userRole) return;

            const validRoles = ['Admin', 'Member', 'Contributor', 'Viewer'];
            if (!validRoles.includes(newRole)) {
                showAlert('Invalid role', 'error');
                return;
            }

            const isGroup = selectedViewUser.principalType === 'Group';
            const requestBody = {
                groupUserAccessRight: newRole,
                principalType: selectedViewUser.principalType || 'User',
                identifier: selectedViewUser.id
            };

            if (!isGroup && selectedViewUser.email) {
                requestBody.emailAddress = selectedViewUser.email;
            }

            try {
                const response = await apiCall(
                    `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`,
                    {
                        method: 'PUT',
                        body: JSON.stringify(requestBody)
                    }
                );

                if (response.ok) {
                    showAlert(`Role changed to ${newRole}`, 'success');
                    // Invalidate cache for this workspace (will refetch on next access)
                    workspaceUserMap.delete(workspaceId);
                    await loadUserWorkspaces();
                }
            } catch (error) {
                showAlert('Failed to change role', 'error');
            }
        }

        async function removeUserFromWorkspace(workspaceId) {
            // Check permission first
            if (!canEditWorkspaceById(workspaceId)) {
                showAlert('You need Admin or Member role in this workspace', 'error');
                return;
            }

            const workspace = userWorkspacesById.get(workspaceId);
            if (!workspace) return;

            if (!confirm(`Remove ${selectedViewUser.displayName} from "${workspace.name}"?`)) return;

            const userIdentifier = selectedViewUser.id;

            try {
                const response = await apiCall(
                    `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users/${encodeURIComponent(userIdentifier)}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    showAlert('Removed from workspace', 'success');
                    // Invalidate cache for this workspace (will refetch on next access)
                    workspaceUserMap.delete(workspaceId);
                    await loadUserWorkspaces();
                }
            } catch (error) {
                cacheBuildingPaused = false;
                showAlert('Failed to remove user', 'error');
            }
        }

        // Update the "Add Workspace Access" button based on available workspaces with permissions
        function updateAddWorkspaceAccessButton() {
            const addBtn = document.getElementById('addWorkspaceAccessBtn');
            if (!addBtn) return;

            // Get workspaces where user doesn't have access yet
            const availableWorkspaces = allWorkspacesCache
                .filter(ws => !userWorkspaces.find(uw => uw.id === ws.id));

            // Check if there's at least one workspace where current user has permission
            const hasAnyPermission = availableWorkspaces.some(ws => canEditWorkspaceById(ws.id));

            addBtn.disabled = !hasAnyPermission;
            addBtn.style.opacity = hasAnyPermission ? '1' : '0.5';
            addBtn.style.cursor = hasAnyPermission ? 'pointer' : 'not-allowed';
            addBtn.title = hasAnyPermission ? '' : 'You need Admin or Member role in available workspaces to add user access';
        }

        function showAddWorkspaceAccessModal() {
            document.getElementById('modalUserName').textContent = selectedViewUser.displayName;

            const availableWorkspaces = allWorkspacesCache
                .filter(ws => !userWorkspaces.find(uw => uw.id === ws.id))
                .sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
            
            const container = document.getElementById('availableWorkspacesList');
            container.innerHTML = '';
            
            if (availableWorkspaces.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">User has access to all workspaces</p>';
            } else {
                availableWorkspaces.forEach(ws => {
                    // Check if current user has permission to add users to this workspace
                    const hasPermission = canEditWorkspaceById(ws.id);

                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #f0f0f0';
                    div.style.opacity = hasPermission ? '1' : '0.5';
                    div.innerHTML = `
                        <label style="display: flex; align-items: center; cursor: ${hasPermission ? 'pointer' : 'not-allowed'};" title="${hasPermission ? '' : 'You need Admin or Member role in this workspace to add users'}">
                            <input type="checkbox" value="${ws.id}" style="margin-right: 10px;" ${!hasPermission ? 'disabled' : ''}>
                            <span><strong>${escapeHtml(ws.name)}</strong></span>
                        </label>
                    `;
                    container.appendChild(div);
                });
            }
            
            document.getElementById('addWorkspaceAccessModal').classList.add('active');
        }
        
        function closeAddWorkspaceAccessModal() {
            document.getElementById('addWorkspaceAccessModal').classList.remove('active');
        }
        
        function filterAvailableWorkspaces() {
            const searchTerm = document.getElementById('workspaceSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('#availableWorkspacesList > div');
            
            items.forEach(div => {
                const text = div.textContent.toLowerCase();
                div.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }
        
        async function addUserToSelectedWorkspaces() {
            const checkboxes = document.querySelectorAll('#availableWorkspacesList input:checked');
            const workspaceIds = Array.from(checkboxes).map(cb => cb.value);

            if (workspaceIds.length === 0) {
                showAlert('Select at least one workspace', 'error');
                return;
            }

            // Check if user has permission for at least one selected workspace
            const hasAnyPermission = workspaceIds.some(wsId => canEditWorkspaceById(wsId));
            if (!hasAnyPermission) {
                showAlert('You need Admin or Member role in selected workspaces', 'error');
                return;
            }

            const role = document.getElementById('bulkWorkspaceRole').value;
            const isGroup = selectedViewUser.principalType === 'Group';

            if (!confirm(`Add ${selectedViewUser.displayName} to ${workspaceIds.length} workspace(s) as ${role}?`)) return;

            let successCount = 0;
            let failureCount = 0;
            const successfulWorkspaces = [];

            // Process in batches instead of sequentially
            for (let i = 0; i < workspaceIds.length; i += BATCH_SIZE) {
                const batch = workspaceIds.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(workspaceId => {
                        const requestBody = {
                            groupUserAccessRight: role,
                            principalType: selectedViewUser.principalType || 'User',
                            identifier: selectedViewUser.id
                        };

                        // For users, also include emailAddress
                        if (!isGroup && selectedViewUser.email) {
                            requestBody.emailAddress = selectedViewUser.email;
                        }

                        return apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`,
                            {
                                method: 'POST',
                                body: JSON.stringify(requestBody)
                            }
                        ).then(response => ({ response, workspaceId }));
                    })
                );

                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.response.ok) {
                        successCount++;
                        // Invalidate cache for this workspace (will refetch on next access)
                        workspaceUserMap.delete(batch[idx]);
                        successfulWorkspaces.push(batch[idx]);
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < workspaceIds.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully added to ${successCount} workspace(s)`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to add to workspaces`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: Added to ${successCount} workspace(s), ${failureCount} failed`, 'error');
            }

            closeAddWorkspaceAccessModal();
            await loadUserWorkspaces();
        }

        async function bulkChangeUserRole(newRole) {
            if (selectedWorkspacesForUser.size === 0) return;

            // Check if user has permission for at least one selected workspace
            const hasAnyPermission = Array.from(selectedWorkspacesForUser).some(wsId => canEditWorkspaceById(wsId));
            if (!hasAnyPermission) {
                showAlert('You need Admin or Member role in selected workspaces', 'error');
                return;
            }

            if (!confirm(`Change role to ${newRole} for ${selectedWorkspacesForUser.size} workspace(s)?`)) return;

            const isGroup = selectedViewUser.principalType === 'Group';
            const workspaceIds = Array.from(selectedWorkspacesForUser);

            // Build request body once (same for all workspaces)
            const requestBody = {
                groupUserAccessRight: newRole,
                principalType: selectedViewUser.principalType || 'User',
                identifier: selectedViewUser.id
            };
            if (!isGroup && selectedViewUser.email) {
                requestBody.emailAddress = selectedViewUser.email;
            }
            const bodyStr = JSON.stringify(requestBody);

            // Process in parallel batches
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < workspaceIds.length; i += BATCH_SIZE) {
                const batch = workspaceIds.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(workspaceId =>
                        apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users`,
                            { method: 'PUT', body: bodyStr }
                        )
                    )
                );

                // Collect successes and failures
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        // Invalidate cache for this workspace
                        workspaceUserMap.delete(batch[idx]);
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < workspaceIds.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully changed ${successCount} role(s) to ${newRole}`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to change roles`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: ${successCount} changed, ${failureCount} failed`, 'error');
            }

            selectedWorkspacesForUser.clear();
            await loadUserWorkspaces();
        }

        async function bulkRemoveUserFromWorkspaces() {
            if (selectedWorkspacesForUser.size === 0) return;

            // Check if user has permission for at least one selected workspace
            const hasAnyPermission = Array.from(selectedWorkspacesForUser).some(wsId => canEditWorkspaceById(wsId));
            if (!hasAnyPermission) {
                showAlert('You need Admin or Member role in selected workspaces', 'error');
                return;
            }

            if (!confirm(`Remove ${selectedViewUser.displayName} from ${selectedWorkspacesForUser.size} workspace(s)?`)) return;

            const userIdentifier = selectedViewUser.id;
            const workspaceIds = Array.from(selectedWorkspacesForUser);
            let successCount = 0;
            let failureCount = 0;

            // Process in parallel batches
            for (let i = 0; i < workspaceIds.length; i += BATCH_SIZE) {
                const batch = workspaceIds.slice(i, i + BATCH_SIZE);
                const results = await Promise.allSettled(
                    batch.map(workspaceId =>
                        apiCall(
                            `https://api.powerbi.com/v1.0/myorg/groups/${workspaceId}/users/${encodeURIComponent(userIdentifier)}`,
                            { method: 'DELETE' }
                        )
                    )
                );

                // Collect successes and failures
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        // Invalidate cache for this workspace
                        workspaceUserMap.delete(batch[idx]);
                    } else {
                        failureCount++;
                    }
                });

                if (i + BATCH_SIZE < workspaceIds.length) {
                    await sleep(RATE_LIMIT_DELAY);
                }
            }

            // Show comprehensive feedback
            if (failureCount === 0) {
                showAlert(`‚úì Successfully removed from ${successCount} workspace(s)`, 'success');
            } else if (successCount === 0) {
                showAlert(`‚úó Failed to remove from workspaces`, 'error');
            } else {
                showAlert(`‚ö† Partially completed: Removed from ${successCount} workspace(s), ${failureCount} failed`, 'error');
            }

            selectedWorkspacesForUser.clear();
            await loadUserWorkspaces();
            rebuildKnownUsersCache();
        }

        function clearUserSelection() {
            selectedViewUser = null;
            userWorkspaces = [];
            selectedWorkspacesForUser.clear();
            document.getElementById('userViewEmailInput').value = '';
            document.getElementById('selectedUserPanel').style.display = 'none';
            document.getElementById('userWorkspacesContainer').style.display = 'none';
        }
        
        // UTILITY FUNCTIONS
        async function apiCall(url, options = {}) {
            if (!accessToken) throw new Error('Not authenticated');

            // Check token expiry
            if (tokenExpiry && Date.now() > tokenExpiry) {
                signOut();
                throw new Error('Session expired. Please sign in again.');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            };

            return fetch(url, { ...defaultOptions, ...options });
        }
        
        function showAlert(message, type = 'info') {
            // Reuse existing alert element for performance
            if (!alertElement) {
                alertElement = document.createElement('div');
                document.body.appendChild(alertElement);
            }

            // Clear any pending hide timeout
            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            alertElement.className = `alert ${type}`;
            alertElement.textContent = message;
            alertElement.style.display = 'block';

            alertTimeout = setTimeout(() => {
                alertElement.style.display = 'none';
            }, 4000);
        }
        
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // WORKSPACE SUGGESTIONS (with debouncing)
        function showWorkspaceSuggestions() {
            clearTimeout(workspaceSuggestionTimeout);
            workspaceSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('workspaceSearch');
                const dropdown = document.getElementById('workspaceSuggestions');
                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || allWorkspaces.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = allWorkspaces
                    .filter(ws => ws.name.toLowerCase().includes(searchTerm))
                    .sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()))
                    .slice(0, 10);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(ws => `
                    <div class="user-search-item" onclick="selectWorkspaceSuggestion('${ws.id}')">
                        <div style="width: 32px; height: 32px; border-radius: 6px; background: #004d90; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üìÅ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${escapeHtml(ws.name)}</div>
                            <div style="font-size: 11px; color: #666;">${ws.type || 'Workspace'}</div>
                        </div>
                    </div>
                `).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        function hideWorkspaceSuggestions() {
            setTimeout(() => {
                document.getElementById('workspaceSuggestions').style.display = 'none';
            }, 200);
        }

        function selectWorkspaceSuggestion(workspaceId) {
            const workspace = allWorkspaces.find(ws => ws.id === workspaceId);
            if (workspace) {
                document.getElementById('workspaceSearch').value = workspace.name;
                hideWorkspaceSuggestions();
                selectWorkspace(workspace);
            }
        }

        // USER SUGGESTIONS (includes Groups, with debouncing)
        function showUserSuggestions() {
            clearTimeout(userSuggestionTimeout);
            userSuggestionTimeout = setTimeout(() => {
                const input = document.getElementById('userViewEmailInput');
                const dropdown = document.getElementById('userSuggestions');
                const searchTerm = input.value.trim().toLowerCase();

                if (searchTerm.length === 0 || knownUsers.size === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = Array.from(knownUsers.values())
                    .filter(user =>
                        (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm))
                    )
                    .sort((a, b) => {
                        const nameA = (a.displayName || a.email || '').toLowerCase();
                        const nameB = (b.displayName || b.email || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    })
                    .slice(0, 25);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(user => {
                    const isGroup = user.principalType === 'Group';
                    const avatarStyle = isGroup
                        ? 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%);'
                        : '';
                    const avatarContent = isGroup ? 'üë•' : getInitials(user.displayName);
                    const typeLabel = isGroup
                        ? '<span style="background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">Group</span>'
                        : '';

                    return `
                        <div class="user-search-item" onclick="selectUserSuggestion('${escapeHtml(user.email)}', '${user.principalType || 'User'}', '${escapeHtml(user.displayName)}')">
                            <div class="user-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${escapeHtml(user.displayName)}${typeLabel}</div>
                                <div style="font-size: 11px; color: #666;">${escapeHtml(user.email)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                dropdown.style.display = 'block';
            }, 150);
        }

        function hideUserSuggestions() {
            setTimeout(() => {
                document.getElementById('userSuggestions').style.display = 'none';
            }, 200);
        }

        function selectUserSuggestion(identifier, principalType = 'User', displayName = '') {
            document.getElementById('userViewEmailInput').value = identifier;
            document.getElementById('userViewEmailInput').dataset.principalType = principalType;
            document.getElementById('userViewEmailInput').dataset.displayName = displayName;
            hideUserSuggestions();
            searchUserByEmail();
        }

        // Cache users and groups from workspace
        function cacheUsersFromWorkspace(users) {
            users.forEach(user => {
                const email = user.emailAddress || user.identifier;
                const principalType = user.principalType || 'User';

                // Cache users with email
                if (email && email.includes('@')) {
                    knownUsers.set(email.toLowerCase(), {
                        displayName: user.displayName || email.split('@')[0],
                        email: email,
                        principalType: principalType,
                        identifier: user.identifier
                    });
                }

                // Also cache groups (they don't have @ in identifier)
                if (principalType === 'Group' && user.displayName) {
                    const groupKey = `group:${user.identifier}`.toLowerCase();
                    knownUsers.set(groupKey, {
                        displayName: user.displayName,
                        email: user.identifier, // Groups use identifier instead of email
                        principalType: 'Group',
                        identifier: user.identifier
                    });
                }
            });
        }

        // Rebuild knownUsers cache from workspaceUserMap (called after user modifications)
        function rebuildKnownUsersCache() {
            knownUsers.clear();
            workspaceUserMap.forEach((users, workspaceId) => {
                cacheUsersFromWorkspace(users);
            });
        }

        // Optimized: Update cache for only the affected workspace instead of full rebuild
        function updateKnownUsersCacheForWorkspace(workspaceId, users) {
            // Get current users in this workspace from cache (before update)
            const oldUsers = workspaceUserMap.get(workspaceId) || [];

            // Build set of identifiers that were in this workspace
            const oldIdentifiers = new Set();
            oldUsers.forEach(user => {
                const email = user.emailAddress || user.identifier;
                if (email && email.includes('@')) {
                    oldIdentifiers.add(email.toLowerCase());
                }
                if (user.principalType === 'Group' && user.displayName) {
                    oldIdentifiers.add(`group:${user.identifier}`.toLowerCase());
                }
            });

            // Build set of identifiers now in this workspace
            const newIdentifiers = new Set();
            users.forEach(user => {
                const email = user.emailAddress || user.identifier;
                if (email && email.includes('@')) {
                    newIdentifiers.add(email.toLowerCase());
                }
                if (user.principalType === 'Group' && user.displayName) {
                    newIdentifiers.add(`group:${user.identifier}`.toLowerCase());
                }
            });

            // OPTIMIZED: Build Set of all users in other workspaces first (O(n))
            const allOtherWorkspaceUsers = new Set();
            workspaceUserMap.forEach((wsUsers, wsId) => {
                if (wsId !== workspaceId) {
                    wsUsers.forEach(u => {
                        const email = u.emailAddress || u.identifier;
                        const key = u.principalType === 'Group'
                            ? `group:${u.identifier}`.toLowerCase()
                            : (email && email.includes('@') ? email.toLowerCase() : null);
                        if (key) allOtherWorkspaceUsers.add(key);
                    });
                }
            });

            // Find removed users (in old but not in new) - O(n) instead of O(n¬≥)
            oldIdentifiers.forEach(id => {
                if (!newIdentifiers.has(id)) {
                    // Check if this user exists in any other workspace (O(1) lookup)
                    if (!allOtherWorkspaceUsers.has(id)) {
                        knownUsers.delete(id);
                    }
                }
            });

            // Add new users to cache
            cacheUsersFromWorkspace(users);

            // Prune cache if it exceeds size limit
            pruneKnownUsersCache();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#workspaceSearch') && !e.target.closest('#workspaceSuggestions')) {
                document.getElementById('workspaceSuggestions').style.display = 'none';
            }
            if (!e.target.closest('#userViewEmailInput') && !e.target.closest('#userSuggestions')) {
                document.getElementById('userSuggestions').style.display = 'none';
            }
            if (!e.target.closest('#newUserEmail') && !e.target.closest('#addUserSuggestions')) {
                document.getElementById('addUserSuggestions').style.display = 'none';
            }
            // Admin panel dropdowns
            if (!e.target.closest('#adminWorkspaceSearch') && !e.target.closest('#adminWorkspaceSuggestions')) {
                const adminWorkspaceDropdown = document.getElementById('adminWorkspaceSuggestions');
                if (adminWorkspaceDropdown) adminWorkspaceDropdown.style.display = 'none';
            }
            if (!e.target.closest('#adminUserSearch') && !e.target.closest('#adminUserSuggestions')) {
                const adminUserDropdown = document.getElementById('adminUserSuggestions');
                if (adminUserDropdown) adminUserDropdown.style.display = 'none';
            }
        });

        // Event delegation for user table (workspace view)
        document.getElementById('userTableBody').addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const identifier = target.dataset.identifier;

            if (action === 'remove-user' && identifier) {
                removeUser(identifier);
            }
        });

        document.getElementById('userTableBody').addEventListener('change', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const identifier = target.dataset.identifier;

            if (action === 'toggle-user' && identifier) {
                toggleUserSelection(identifier);
            } else if (action === 'stage-role' && identifier) {
                stageRoleChange(identifier, target.dataset.role);
            }
        });

        // Event delegation for user workspaces table (user view)
        document.getElementById('userWorkspacesTable').addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const workspaceId = target.dataset.workspaceId;

            if (action === 'change-workspace-role' && workspaceId) {
                changeUserWorkspaceRole(workspaceId);
            } else if (action === 'remove-from-workspace' && workspaceId) {
                removeUserFromWorkspace(workspaceId);
            }
        });

        document.getElementById('userWorkspacesTable').addEventListener('change', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const workspaceId = target.dataset.workspaceId;

            if (action === 'toggle-workspace' && workspaceId) {
                toggleWorkspaceSelection(workspaceId);
            }
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            // Check for cached token from previous session
            const cached = sessionStorage.getItem('pbi_token');
            if (cached && cached.startsWith('eyJ')) {
                document.getElementById('manualToken').value = cached;
                authenticateWithToken();
            }
        });

        // SAFEGUARD: Memory leak cleanup - Clear all timers on page unload
        window.addEventListener('beforeunload', () => {
            // Clear all active timers
            stopBackgroundSync();
            clearTimeout(refreshDebounceTimer);
            clearTimeout(alertTimeout);
            clearTimeout(workspaceSuggestionTimeout);
            clearTimeout(userSuggestionTimeout);
            clearTimeout(addUserSuggestionTimeout);
            clearTimeout(adminSuggestionTimeout);

            console.log('Cleanup: All timers cleared');
        });
    </script>
</body>
</html>
